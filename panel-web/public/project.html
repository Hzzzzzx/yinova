<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é¡¹ç›® Â· Yinova</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet" />
  <style>
    :root {
      --black: #000000;
      --black-light: #0c0c0c;
      --white: #f0eeec;
      --white-dim: #a8a6a4;
      --gold: #c9a227;
      --gold-dim: #9a7b20;
      --text: var(--white);
      --text-dim: var(--white-dim);
      --border: rgba(201, 162, 39, 0.3);
      --glow: rgba(201, 162, 39, 0.45);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "Noto Serif SC", "PingFang SC", serif;
      background: #000;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }
    #starfield {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .star {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 228, 200, 0.88);
      animation: star-breathe var(--dur, 2.5s) ease-in-out var(--delay, 0s) infinite;
    }
    @keyframes star-breathe {
      0%, 100% { filter: brightness(0.7); }
      50% { filter: brightness(1.05); }
    }
    .page-content {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 720px;
      padding: 28px 24px 48px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .header h1 {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0;
      color: var(--gold);
      letter-spacing: 0.1em;
    }
    .link-back {
      color: var(--gold-dim);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .link-back:hover { color: var(--gold); }
    .breadcrumb { font-size: 0.9rem; }
    .breadcrumb-sep { color: var(--text-dim); margin: 0 4px; }
    .breadcrumb-project { color: var(--gold); }
    .project-name {
      padding: 14px 18px;
      margin-bottom: 24px;
      background: var(--black-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1.05rem;
      color: var(--gold);
    }
    /* å¤ªæ + å››å‘¨å¦ç¯å½¢ */
    .taiji-section {
      position: relative;
      width: 100%;
      min-height: 280px;
      margin-bottom: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .taiji-ring {
      position: relative;
      width: 320px;
      height: 320px;
    }
    .taiji-wrap {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 200px;
      height: 200px;
      margin-left: -100px;
      margin-top: -100px;
      filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));
      animation: taiji-glow-breathe 4s ease-in-out infinite;
    }
    @keyframes taiji-glow-breathe {
      0%, 100% { filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); }
      50% { filter: drop-shadow(0 0 32px rgba(255,255,255,0.35)); }
    }
    .taiji-wrap svg {
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .taiji-wrap svg .half { stroke: none; }
    .taiji-wrap svg .half-white { fill: #fff; }
    .taiji-wrap svg .half-black { fill: #000; }
    .taiji-wrap svg .stroke { fill: none; stroke: rgba(255,255,255,0.5); stroke-width: 1; }
    .taiji-wrap svg .eye-white { fill: #fff; }
    .taiji-wrap svg .eye-black { fill: #000; }
    /* é˜´é˜³æŒ‰é’®ï¼šåœ¨å¤ªæé±¼å†…ï¼Œç›¸å¯¹ taiji-wrap å®šä½ */
    .taiji-dot {
      position: absolute;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      padding: 0;
      transition: box-shadow 0.2s, background 0.2s;
      z-index: 10;
    }
    /* æœªç‚¹å‡»æ—¶é€æ˜ï¼Œæ‚¬åœç•¥æ˜¾ */
    .taiji-dot[data-robot="main"] { left: 50%; top: 32%; transform: translate(-50%, -50%); background: rgba(120,120,120,0.3); }
    .taiji-dot[data-robot="lan"] { left: 50%; top: 68%; transform: translate(-50%, -50%); background: rgba(120,120,120,0.3); }
    .taiji-dot[data-robot="main"]:hover { background: rgba(140,140,140,0.45); }
    .taiji-dot[data-robot="lan"]:hover { background: rgba(140,140,140,0.45); }
    .taiji-dot.running { }
    /* ç‚¹å‡»åï¼šåŸé»‘é’®(é˜´)å˜ç™½+ç™½å‘¼å¸å…‰ï¼ŒåŸç™½é’®(é˜³)å˜é»‘+é»‘å‘¼å¸å…‰ */
    .taiji-dot[data-robot="main"].running {
      background: #f0ece8;
      animation: breathe-dot-white 2s ease-in-out infinite;
    }
    .taiji-dot[data-robot="lan"].running {
      background: #0a0a0e;
      animation: breathe-dot-black 2s ease-in-out infinite;
    }
    .taiji-dot[data-robot="main"].starting {
      background: #f0ece8;
      animation: breathe-dot-white 1.5s ease-in-out infinite;
    }
    .taiji-dot[data-robot="lan"].starting {
      background: #0a0a0e;
      animation: breathe-dot-black 1.5s ease-in-out infinite;
    }
    @keyframes breathe-dot-black {
      0%, 100% { box-shadow: 0 0 8px rgba(0,0,0,0.8), 0 0 16px rgba(40,40,55,0.5); }
      50% { box-shadow: 0 0 18px rgba(0,0,0,0.95), 0 0 28px rgba(50,50,70,0.6); }
    }
    @keyframes breathe-dot-white {
      0%, 100% { box-shadow: 0 0 8px rgba(255,255,255,0.6), 0 0 16px rgba(255,255,255,0.3); }
      50% { box-shadow: 0 0 20px rgba(255,255,255,0.9), 0 0 32px rgba(255,255,255,0.5); }
    }
    .ring-hex {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: auto;
      height: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: none;
      border: none;
      border-radius: 0;
      font-size: 0.95rem;
      font-family: "ZCOOL KuaiLe", serif;
      color: var(--gold);
      text-shadow: 0 0 10px rgba(201, 162, 39, 0.5);
    }
    .ring-hex:hover {
      color: rgba(255, 220, 120, 1);
      text-shadow: 0 0 12px rgba(201, 162, 39, 0.7);
    }
    .empty-ring-hint {
      display: none;
    }
    .btn-open-select-hex {
      margin-bottom: 24px;
      padding: 10px 24px;
      background: transparent;
      border: 1px solid var(--gold-dim);
      border-radius: 6px;
      color: var(--gold);
      font-size: 0.9rem;
      font-family: inherit;
      cursor: pointer;
      letter-spacing: 0.08em;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .btn-open-select-hex:hover {
      border-color: var(--gold);
      box-shadow: 0 0 12px var(--glow);
    }
    .taiji-actions.empty .btn-open-select-hex {
      border-color: var(--gold);
      box-shadow: 0 0 16px var(--glow);
    }
    /* é€‰å¦å¼¹çª— */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 100;
      background: rgba(0,0,0,0.75);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal-select-hex {
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: var(--black-light);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 0 40px rgba(0,0,0,0.5);
    }
    .modal-select-hex h2 {
      margin: 0;
      padding: 16px 20px;
      font-size: 0.95rem;
      color: var(--gold-dim);
      font-weight: 500;
      letter-spacing: 0.1em;
      border-bottom: 1px solid var(--border);
    }
    .modal-select-hex .modal-body {
      overflow-y: auto;
      padding: 16px;
    }
    .select-hex-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
    }
    .select-hex-btn {
      padding: 10px 6px;
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      font-family: "ZCOOL KuaiLe", serif;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .select-hex-btn:hover {
      border-color: var(--gold-dim);
      background: rgba(201, 162, 39, 0.08);
    }
    .select-hex-btn.added {
      border-color: var(--gold-dim);
      background: rgba(201, 162, 39, 0.15);
      color: var(--gold);
    }
    .modal-select-hex .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      text-align: right;
    }
    .modal-btn-done {
      padding: 8px 20px;
      background: transparent;
      border: 1px solid var(--gold-dim);
      border-radius: 6px;
      color: var(--gold);
      font-size: 0.9rem;
      font-family: inherit;
      cursor: pointer;
    }
    .modal-btn-done:hover { background: rgba(201, 162, 39, 0.12); }
    .modal-clear-confirm .modal-clear-message { margin: 0 0 12px; color: var(--text); }
    .modal-clear-confirm .modal-clear-checkbox { display: block; margin-bottom: 12px; color: var(--text-dim); font-size: 0.9rem; cursor: pointer; }
    .modal-clear-confirm .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }
    .toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 6px;
      background: var(--black-light);
      border: 1px solid var(--gold-dim);
      color: var(--gold);
      font-size: 0.875rem;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 10;
    }
    .toast.show { opacity: 1; }

    /* æœ¬é¡¹ç›®å¦è±¡å¯åœ */
    .section-hex-switches {
      margin-top: 24px;
      padding-top: 18px;
      border-top: 1px solid var(--border);
    }
    .section-hex-switches h2 {
      font-size: 0.95rem;
      color: var(--gold-dim);
      font-weight: 500;
      letter-spacing: 0.08em;
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .hex-switches-batch-btns {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }
    .btn-hex-batch {
      font-size: 0.78rem;
      color: var(--text-dim);
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px 9px;
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
    }
    .btn-hex-batch:hover { color: var(--gold); border-color: var(--gold-dim); }
    .btn-hex-batch.stop-all:hover { color: #e05555; border-color: #e05555; }
    .btn-hex-batch:disabled { opacity: 0.5; cursor: not-allowed; }
    .hex-switches {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .hex-switch-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--black-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .hex-switch-item .hex-name { color: var(--gold); font-weight: 500; min-width: 2em; }
    .hex-switch-item .hex-status { color: var(--text-dim); font-size: 0.8rem; }
    .hex-switch-item.running .hex-status { color: #4ade80; }
    .hex-switch-item .btn-hex-action {
      padding: 4px 10px;
      font-size: 0.75rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
    }
    .hex-switch-item .btn-hex-action:hover { border-color: var(--gold-dim); color: var(--gold); }
    .hex-switch-item .btn-hex-action.stop:hover { border-color: rgba(220,80,80,0.6); color: #dc5050; }
    /* ä¸å¦å¯¹è¯å’Œä¸é˜´å¯¹è¯å®¹å™¨ï¼ˆå·¦å³å¸ƒå±€ï¼Œå¯æ‹–åŠ¨è°ƒæ•´ï¼›å¯åˆ‡æ¢å æ»¡å±å¹•ï¼‰ */
    .chat-sections-container {
      display: flex;
      gap: 0;
      margin-top: 28px;
      padding-top: 20px;
      padding-bottom: 0;
      border-top: 1px solid var(--border);
      position: relative;
      background: #000;
      box-sizing: border-box;
      /* æ’‘æ»¡è§†å£å®½åº¦ï¼Œä¸äº§ç”Ÿæ¨ªå‘æ»šåŠ¨ */
      width: 100vw;
      max-width: 100vw;
      margin-left: calc(-50vw + 50%);
      height: 100vh;
      min-height: 100vh;
      overflow: hidden;
    }
    .chat-sections-container.fullscreen {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: 0;
      padding: 0;
      padding-top: 48px;
      border: none;
      z-index: 100;
      min-height: 0;
      height: 100%;
    }
    .chat-fullscreen-toggle {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 12px;
      font-size: 0.8rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-dim);
      cursor: pointer;
      z-index: 25;
    }
    .chat-fullscreen-toggle:hover {
      border-color: var(--gold-dim);
      color: var(--gold);
    }
    .chat-sections-container.fullscreen .chat-fullscreen-toggle {
      top: 12px;
      right: 20px;
      z-index: 11;
    }
    .chat-sections-container .section-hex-chat,
    .chat-sections-container .section-yin-chat {
      display: flex;
      flex-direction: column;
      min-height: 0;
      height: 100%;
      overflow: hidden;
      padding: 20px;
      padding-top: 44px;
      border-right: 1px solid var(--border);
      box-sizing: border-box;
    }
    .chat-sections-container.fullscreen .section-hex-chat,
    .chat-sections-container.fullscreen .section-yin-chat {
      height: 100%;
      padding-top: 20px;
    }
    .chat-sections-container .section-yin-chat {
      border-right: none;
    }
    .chat-sections-container .section-hex-chat > h2,
    .chat-sections-container .section-yin-chat > h2 {
      flex-shrink: 0;
      margin-bottom: 12px;
    }
    .chat-sections-container .hex-chat-file-warn,
    .chat-sections-container .hex-chat-empty,
    .chat-sections-container .hex-chat-mode-row,
    .chat-sections-container .hex-chat-row,
    .chat-sections-container .yin-chat-row {
      flex-shrink: 0;
    }
    .chat-sections-container .hex-chat-status {
      flex-shrink: 0;
    }
    .chat-resizer {
      width: 4px;
      background: var(--border);
      cursor: col-resize;
      flex-shrink: 0;
      position: relative;
      transition: background 0.2s;
    }
    .chat-resizer:hover {
      background: var(--gold-dim);
    }
    .chat-resizer::before {
      content: '';
      position: absolute;
      left: -2px;
      right: -2px;
      top: 0;
      bottom: 0;
    }
    .chat-resizer.resizing {
      background: var(--gold);
    }
    @media (max-width: 900px) {
      .chat-sections-container {
        flex-direction: column;
      }
      .chat-resizer {
        width: 100%;
        height: 4px;
        cursor: row-resize;
      }
    }
    /* å¸ƒå±€åˆ‡æ¢å™¨ï¼ˆ3ç‚¹ï¼Œæ”¾åœ¨èŠå¤©å®¹å™¨é¡¶éƒ¨ä¸­å¤®ï¼‰ */
    .layout-switcher {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 7px;
      z-index: 15;
    }
    .layout-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      cursor: pointer;
      background: rgba(201,162,39,0.2);
      border: 1px solid rgba(201,162,39,0.3);
      transition: background 0.15s, transform 0.15s, border-color 0.15s;
      flex-shrink: 0;
    }
    .layout-dot:hover { transform: scale(1.35); border-color: var(--gold-dim); background: rgba(201,162,39,0.4); }
    .layout-dot.active { background: var(--gold); border-color: var(--gold); }
    /* ä¸å¦å¯¹è¯ï¼ˆç¾¤èŠå¼ï¼‰ */
    .section-hex-chat {
      flex: 0 0 50%;
      min-width: 0;
      max-width: 100%;
      position: relative;
    }
    .section-hex-chat h2 {
      font-size: 0.95rem;
      color: var(--gold-dim);
      font-weight: 500;
      letter-spacing: 0.08em;
      margin: 0 0 12px 0;
      padding-right: 32px;
    }
    .hex-chat-file-warn {
      padding: 10px 14px;
      margin-bottom: 10px;
      background: rgba(200, 80, 80, 0.15);
      border: 1px solid rgba(200, 80, 80, 0.4);
      border-radius: 6px;
      color: #e88;
      font-size: 0.85rem;
    }
    .hex-chat-empty {
      padding: 14px 18px;
      background: var(--black-light);
      border: 1px dashed var(--border);
      border-radius: 6px;
      color: var(--text-dim);
      font-size: 0.9rem;
    }
    .hex-chat-mode-row {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-top: 10px;
      font-size: 0.88rem;
      color: var(--text-dim);
    }
    .hex-chat-mode-label { flex-shrink: 0; }
    .hex-chat-mode-opt { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; }
    .hex-chat-mode-opt input { accent-color: var(--gold); }
    .hex-chat-mode-opt:hover { color: var(--text); }
    .hex-chat-rounds-wrap { position: relative; margin-left: 12px; }
    .hex-chat-rounds-btn {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; background: transparent; border: 1px solid var(--border); border-radius: 6px;
      color: var(--text-dim); font-size: 0.88rem; cursor: pointer;
    }
    .hex-chat-rounds-btn:hover { border-color: var(--gold-dim); color: var(--gold); }
    .hex-chat-rounds-btn.disabled { opacity: 0.6; cursor: default; pointer-events: none; }
    .hex-chat-rounds-arrow { font-size: 0.7rem; opacity: 0.8; }
    .hex-chat-rounds-popover {
      display: none; position: absolute; left: 0; top: 100%; margin-top: 4px;
      padding: 6px; background: var(--black-light); border: 1px solid var(--border); border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4); z-index: 20;
    }
    .hex-chat-rounds-popover.show { display: block; }
    .hex-chat-rounds-opt {
      display: block; width: 100%; min-width: 80px; padding: 6px 12px; margin: 0; border: none; border-radius: 4px;
      background: transparent; color: var(--text); font-size: 0.88rem; text-align: left; cursor: pointer;
    }
    .hex-chat-rounds-opt:hover { background: rgba(201, 162, 39, 0.15); color: var(--gold); }
    .hex-chat-rounds-opt.active { background: rgba(201, 162, 39, 0.2); color: var(--gold); }
    .hex-chat-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
    }
    .hex-chat-row input {
      flex: 1;
      padding: 10px 14px;
      background: #000;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.95rem;
      font-family: inherit;
    }
    .hex-chat-row input::placeholder { color: var(--text-dim); }
    .hex-chat-send {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid var(--gold-dim);
      border-radius: 6px;
      color: var(--gold);
      font-size: 0.9rem;
      font-family: inherit;
      cursor: pointer;
      white-space: nowrap;
    }
    .hex-chat-send:hover { background: rgba(201, 162, 39, 0.12); }
    .hex-chat-send:disabled { opacity: 0.6; cursor: not-allowed; }
    .hex-chat-status {
      margin-top: 8px;
      padding: 8px 12px;
      background: var(--black-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--text-dim);
      min-height: 20px;
      display: none;
    }
    .hex-chat-status.show { display: block; }
    .hex-chat-status .st-item { margin-right: 12px; }
    .hex-chat-status .st-ok { color: #6a9; }
    .hex-chat-status .st-fail { color: #c66; }
    .hex-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
      min-height: 0;
    }
    /* ä¸é˜´å¯¹è¯ */
    .section-yin-chat {
      flex: 1;
      min-width: 0;
      position: relative;
    }
    .section-yin-chat h2 {
      font-size: 0.95rem;
      color: var(--gold-dim);
      font-weight: 500;
      letter-spacing: 0.08em;
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-right: 32px;
    }
    .yin-chat-hint {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin: -6px 0 8px 0;
    }
    .yin-chat-clear-btn {
      font-size: 0.78rem;
      color: var(--text-dim);
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
      font-family: inherit;
      letter-spacing: 0;
      white-space: nowrap;
    }
    .yin-chat-clear-btn:hover { color: #e05555; border-color: #e05555; }
    .yin-chat-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
    }
    .yin-chat-row input {
      flex: 1;
      padding: 10px 14px;
      background: #000;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.95rem;
      font-family: inherit;
    }
    .yin-chat-row input::placeholder { color: var(--text-dim); }
    .yin-chat-send {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid var(--gold-dim);
      border-radius: 6px;
      color: var(--gold);
      font-size: 0.9rem;
      font-family: inherit;
      cursor: pointer;
      white-space: nowrap;
    }
    .yin-chat-send:hover { background: rgba(201, 162, 39, 0.12); }
    .yin-chat-send:disabled { opacity: 0.6; cursor: not-allowed; }
    .yin-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
      min-height: 0;
    }
    .yin-chat-msg {
      margin: 8px 0;
      font-size: 0.9rem;
      line-height: 1.45;
    }
    .yin-chat-msg.user { color: var(--white-dim); }
    .yin-chat-msg.user .who { color: var(--gold-dim); }
    .yin-chat-msg.yin .who { color: var(--gold); }
    .yin-chat-msg .who { margin-right: 6px; font-weight: 500; }
    .hex-chat-messages {
      margin-top: 14px;
      min-height: 60px;
    }
    .hex-chat-msg {
      margin: 10px 0;
      padding: 12px 14px;
      background: var(--black-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.9rem;
      line-height: 1.45;
    }
    .hex-chat-msg .hex-name {
      color: var(--gold);
      font-weight: 500;
      margin-right: 8px;
    }
    .hex-chat-mode-tag {
      display: inline-block;
      margin-left: 4px;
      padding: 0 4px;
      font-size: 0.7rem;
      color: var(--text-dim);
      border: 1px solid var(--border);
      border-radius: 3px;
    }
    .hex-chat-msg.err { border-color: rgba(220,80,80,0.4); color: var(--text-dim); }
    .hex-chat-toolbar { margin-top: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; flex-wrap: wrap; }
    .hex-chat-clear-btn { padding: 4px 10px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-dim); cursor: pointer; }
    .hex-chat-clear-btn:hover { border-color: var(--gold-dim); color: var(--gold); }
    .hex-chat-state { color: var(--text-dim); font-size: 0.8rem; }
    .hex-chat-share { margin-left: 8px; font-size: 0.75rem; color: var(--gold-dim); cursor: pointer; }
    .hex-chat-share:hover { color: var(--gold); }

    /* æ´¾å‘ä»»åŠ¡é¢æ¿ */
    .dispatch-panel {
      margin: 8px 0 4px;
      border: 1px solid rgba(201,162,39,0.35);
      border-radius: 10px;
      background: rgba(20,18,14,0.96);
      padding: 14px 16px;
      font-size: 0.85rem;
    }
    .dispatch-panel-title {
      font-size: 0.82rem;
      color: var(--gold);
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dispatch-context {
      font-size: 0.78rem;
      color: var(--text-dim);
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 5px;
      padding: 6px 10px;
      margin-bottom: 10px;
      max-height: 80px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.5;
    }
    .dispatch-context-label {
      font-size: 0.72rem;
      color: var(--text-dim);
      opacity: 0.6;
      margin-bottom: 4px;
    }
    .dispatch-instruction {
      width: 100%;
      box-sizing: border-box;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(201,162,39,0.25);
      border-radius: 5px;
      color: var(--text);
      font-size: 0.83rem;
      padding: 7px 10px;
      resize: vertical;
      min-height: 56px;
      font-family: inherit;
      line-height: 1.5;
      outline: none;
      margin-bottom: 10px;
    }
    .dispatch-instruction:focus { border-color: rgba(201,162,39,0.5); }
    .dispatch-hex-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .dispatch-hex-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 9px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      font-size: 0.78rem;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
    }
    .dispatch-hex-chip.selected {
      border-color: rgba(201,162,39,0.6);
      background: rgba(201,162,39,0.12);
      color: var(--gold);
    }
    .dispatch-hex-chip input { display: none; }
    .dispatch-actions { display: flex; gap: 8px; align-items: center; }
    .dispatch-send-btn {
      padding: 5px 16px;
      background: rgba(201,162,39,0.15);
      border: 1px solid rgba(201,162,39,0.45);
      border-radius: 5px;
      color: var(--gold);
      font-size: 0.82rem;
      cursor: pointer;
      transition: background 0.15s;
      font-weight: 500;
    }
    .dispatch-send-btn:hover { background: rgba(201,162,39,0.28); }
    .dispatch-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .dispatch-cancel-btn {
      padding: 5px 12px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 5px;
      color: var(--text-dim);
      font-size: 0.82rem;
      cursor: pointer;
    }
    .dispatch-cancel-btn:hover { border-color: rgba(255,255,255,0.25); color: var(--text); }
    .dispatch-status { font-size: 0.78rem; color: var(--text-dim); margin-left: 6px; }

    /* P4: è®¨è®ºæ‘˜è¦ä¸é˜´çš„å†³ç­–åŒºåŸŸ */
    .hex-chat-summary-block {
      margin: 12px 0 4px;
      border: 1px solid rgba(201,162,39,0.25);
      border-radius: 8px;
      background: rgba(201,162,39,0.04);
      padding: 10px 14px;
      font-size: 0.85rem;
    }
    .hex-chat-summary-label {
      font-size: 0.78rem;
      color: var(--gold-dim);
      margin-bottom: 6px;
      font-weight: 500;
    }
    .hex-chat-summary-content {
      color: var(--text);
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .hex-chat-ask-yin-btn, .hex-chat-summary-retry, .hex-chat-decision-copy {
      display: inline-block;
      margin-top: 8px;
      padding: 3px 10px;
      font-size: 0.78rem;
      background: rgba(201,162,39,0.12);
      border: 1px solid rgba(201,162,39,0.35);
      border-radius: 4px;
      color: var(--gold);
      cursor: pointer;
      transition: background 0.15s;
    }
    .hex-chat-ask-yin-btn:hover, .hex-chat-summary-retry:hover, .hex-chat-decision-copy:hover { background: rgba(201,162,39,0.22); }
    .hex-chat-ask-yin-btn:disabled { opacity: 0.5; cursor: default; }
    .hex-chat-summary-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .hex-chat-regen-wrap { font-size: 0.75rem; color: var(--text-muted); margin-left: 6px; }
    .hex-chat-regen-select {
      font-size: 0.75rem;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 3px;
      color: var(--text);
      padding: 1px 4px;
      cursor: pointer;
    }
    .hex-chat-yin-decision {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .hex-chat-yin-decision .hex-chat-summary-label {
      color: rgba(180,180,220,0.7);
    }
    .hex-chat-yin-decision .hex-chat-summary-content {
      color: rgba(220,220,255,0.9);
    }
  /* Markdown æ¸²æŸ“æ ·å¼ */
  .hex-chat-md p { margin: 0 0 6px; }
  .hex-chat-md p:last-child { margin-bottom: 0; }
  .hex-chat-md ul, .hex-chat-md ol { margin: 4px 0 6px 18px; padding: 0; }
  .hex-chat-md li { margin-bottom: 2px; }
  .hex-chat-md h1, .hex-chat-md h2, .hex-chat-md h3 { margin: 8px 0 4px; font-size: 1em; color: var(--gold); }
  .hex-chat-md code { background: rgba(255,255,255,0.1); border-radius: 3px; padding: 1px 5px; font-family: monospace; font-size: 0.92em; }
  .hex-chat-md pre { background: rgba(0,0,0,0.35); border-radius: 6px; padding: 8px 12px; overflow-x: auto; margin: 6px 0; }
  .hex-chat-md pre code { background: none; padding: 0; }
  .hex-chat-md blockquote { border-left: 3px solid var(--gold); margin: 6px 0; padding: 2px 10px; color: var(--text-muted); }
  .hex-chat-md strong { color: #e8d6a0; }
  .hex-chat-md a { color: var(--gold); }
  .yin-chat-md p { margin: 0 0 6px; }
  .yin-chat-md p:last-child { margin-bottom: 0; }
  .yin-chat-md ul, .yin-chat-md ol { margin: 4px 0 6px 18px; padding: 0; }
  .yin-chat-md li { margin-bottom: 2px; }
  .yin-chat-md code { background: rgba(255,255,255,0.1); border-radius: 3px; padding: 1px 5px; font-family: monospace; font-size: 0.92em; }
  .yin-chat-md pre { background: rgba(0,0,0,0.35); border-radius: 6px; padding: 8px 12px; overflow-x: auto; margin: 6px 0; }
  .yin-chat-md pre code { background: none; padding: 0; }
  .yin-chat-md strong { color: #e8d6a0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
</head>
<body>
  <div id="starfield"></div>
  <div class="page-content">
    <div class="header">
      <nav class="breadcrumb" id="breadcrumb">
        <a href="projects.html" class="link-back" id="linkBack">â† é¡¹ç›®åˆ—è¡¨</a>
        <span class="breadcrumb-sep" id="breadcrumbSep" style="display:none;"> Â· </span>
        <span class="breadcrumb-project" id="breadcrumbProject"></span>
      </nav>
      <h1>é¡¹ç›®</h1>
      <span></span>
    </div>
    <div class="project-name" id="projectName">åŠ è½½ä¸­â€¦</div>

    <section class="taiji-section">
      <div class="taiji-ring" id="taijiRing">
        <div class="taiji-wrap">
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <path class="half half-white" d="M50 0 A25 25 0 0 1 50 50 A25 25 0 0 0 50 100 A50 50 0 0 0 50 0"/>
            <path class="half half-black" d="M50 100 A25 25 0 0 1 50 50 A25 25 0 0 0 50 0 A50 50 0 0 0 50 100"/>
            <circle class="eye-black" cx="50" cy="25" r="5"/>
            <circle class="eye-white" cx="50" cy="75" r="5"/>
            <circle class="stroke" cx="50" cy="50" r="50"/>
            <path class="stroke" d="M50 0 A25 25 0 0 1 50 50 A25 25 0 0 0 50 100"/>
          </svg>
          <button type="button" class="taiji-dot" data-robot="main" title="é˜´ Â· å¹³å°æ€»æ§ Â· ç‚¹å‡»å¯åŠ¨/åœæ­¢" aria-label="é˜´"></button>
          <button type="button" class="taiji-dot" data-robot="lan" title="é˜³ Â· ç‚¹å‡»å¯åŠ¨/åœæ­¢" aria-label="é˜³"></button>
        </div>
        <div id="ringHexes"></div>
      </div>
    </section>
    <div class="taiji-actions" id="taijiActions">
      <button type="button" class="btn-open-select-hex" id="btnOpenSelectHex">é€‰å¦</button>
    </div>

    <div class="modal-overlay" id="modalSelectHex" aria-hidden="true">
      <div class="modal-select-hex">
        <h2>é€‰æ‹©å¦è±¡ Â· ç‚¹å‡»åŠ å…¥/å–æ¶ˆåŠ å…¥æœ¬é¡¹ç›®</h2>
        <div class="modal-body">
          <div class="select-hex-grid" id="selectHexGrid"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="modal-btn-done" id="modalBtnDone">å®Œæˆ</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="modalClearConfirm" aria-hidden="true">
      <div class="modal-select-hex modal-clear-confirm">
        <p class="modal-clear-message" id="modalClearMessage"></p>
        <label class="modal-clear-checkbox"><input type="checkbox" id="modalClearMemory" /> åŒæ—¶æ¸…ç©ºæœ¬é¡¹ç›®è®°å¿†</label>
        <div class="modal-footer">
          <button type="button" class="modal-btn-done" id="modalClearCancel">å–æ¶ˆ</button>
          <button type="button" class="modal-btn-done" id="modalClearOk">ç¡®å®š</button>
        </div>
      </div>
    </div>

    <section class="section-hex-switches" id="sectionHexSwitches" style="display:none;">
      <h2>æœ¬é¡¹ç›®å¦è±¡ Â· å¯åœ
        <span class="hex-switches-batch-btns">
          <button type="button" class="btn-hex-batch" id="btnStartAllHex">ä¸€é”®å¯åŠ¨</button>
          <button type="button" class="btn-hex-batch stop-all" id="btnStopAllHex">ä¸€é”®åœæ­¢</button>
        </span>
      </h2>
      <div class="hex-switches" id="hexSwitches"></div>
    </section>

    <div class="chat-sections-container" id="chatSectionsContainer">
      <button type="button" class="chat-fullscreen-toggle" id="chatFullscreenToggle" title="ç‚¹å‡»å›ºå®šä¸ºå…¨å±">å›ºå®š</button>
      <div class="layout-switcher" id="layoutSwitcher">
        <span class="layout-dot" id="dotHex" title="ä¸å¦å¯¹è¯å…¨å±"></span>
        <span class="layout-dot active" id="dotHalf" title="å·¦å³å„åŠï¼Œå¯æ‹–åŠ¨è°ƒæ•´"></span>
        <span class="layout-dot" id="dotYin" title="ä¸é˜´å¯¹è¯å…¨å±"></span>
      </div>
      <section class="section-hex-chat" id="panelHexChat">
        <h2>ä¸å¦å¯¹è¯</h2>
        <div class="hex-chat-file-warn" id="hexChatFileWarn" style="display:none;">å½“å‰ä¸ºæ–‡ä»¶æ–¹å¼æ‰“å¼€é¡µé¢ï¼Œä¸å¦å¯¹è¯æ— æ³•è¯·æ±‚æ¥å£ã€‚è¯·ç”¨æµè§ˆå™¨æ‰“å¼€ï¼š<strong>http://localhost:3999/project.html</strong>ï¼ˆå¹¶ç¡®ä¿å·²å¯åŠ¨é¢æ¿ï¼‰ã€‚</div>
        <div class="hex-chat-empty" id="hexChatEmpty">è¯·å…ˆåœ¨ã€Œé€‰å¦ã€ä¸­ä¸ºæœ¬é¡¹ç›®æ·»åŠ å¦è±¡ï¼Œå†åœ¨æ­¤å‘æ¶ˆæ¯ï¼›å‘æœ¬é¡¹ç›®å„å¦ç¾¤å‘ï¼Œå›å¤æŒ‰å¦å±•ç¤ºï¼ˆç±»ä¼¼ç¾¤èŠï¼‰ã€‚</div>
        <div class="hex-chat-mode-row" id="hexChatModeRow" style="display:none;">
          <span class="hex-chat-mode-label">æ¨¡å¼ï¼š</span>
        <label class="hex-chat-mode-opt" title="ç¾¤å‘å•èŠï¼šæ‰€æœ‰å¦éƒ½æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†çœ‹ä¸åˆ°å…¶ä»–å¦çš„å›å¤ã€‚@ è§¦å‘æ—¶åªè®©è¢« @ çš„å¦å›å¤ã€‚"><input type="radio" name="hexChatMode" value="single" /> ç¾¤å‘å•èŠ</label>
        <label class="hex-chat-mode-opt" title="ç¾¤è®¨è®ºï¼šå„å¦èƒ½çœ‹åˆ°å…¶ä»–å¦çš„å›å¤ï¼Œå¹¶å¯è¿½åŠ è®¨è®ºã€‚"><input type="radio" name="hexChatMode" value="discuss" checked /> ç¾¤è®¨è®º</label>
        <label class="hex-chat-mode-opt" title="æ‰§è¡Œä»»åŠ¡ï¼šé€šè¿‡ WebSocket è®©æŒ‡å®šå¦çœŸæ­£è°ƒç”¨å·¥å…·æ‰§è¡Œä»»åŠ¡ï¼ˆå†™æ–‡ä»¶ã€è¿è¡Œå‘½ä»¤ç­‰ï¼‰ï¼Œç»“æœä¿å­˜åˆ°é¡¹ç›®äº§å‡ºç›®å½•ã€‚éœ€æŒ‡å®š @å¦åã€‚"><input type="radio" name="hexChatMode" value="agent" /> âš¡ æ‰§è¡Œä»»åŠ¡</label>
          <span class="hex-chat-rounds-wrap" id="hexChatRoundsWrap">
            <button type="button" class="hex-chat-rounds-btn" id="hexChatRoundsBtn" title="é€‰æ‹©è®¨è®ºè½®æ•°">å¤šè½®ï¼š<span id="hexChatRoundsValue">2</span> è½® <span class="hex-chat-rounds-arrow">â–¼</span></button>
            <div class="hex-chat-rounds-popover" id="hexChatRoundsPopover">
              <button type="button" class="hex-chat-rounds-opt" data-rounds="1" title="1è½®ï¼šå„å¦ç‹¬ç«‹å›å¤ï¼Œä¸äº’ç›¸çœ‹">1 è½®</button>
              <button type="button" class="hex-chat-rounds-opt" data-rounds="2" title="2è½®ï¼šé¦–è½®åå„å¦çœ‹åˆ°å½¼æ­¤å›å¤ï¼Œå¯è¿½åŠ ">2 è½®</button>
              <button type="button" class="hex-chat-rounds-opt" data-rounds="3" title="3è½®ï¼š2è½®åŸºç¡€ä¸Šå†åŠ ä¸€è½®æ”¶å£è¡¥å……">3 è½®</button>
              <button type="button" class="hex-chat-rounds-opt" data-rounds="4" title="4è½®ï¼šæ·±åº¦è®¨è®ºï¼Œæ–¹æ¡ˆç»†åŒ–">4 è½®</button>
              <button type="button" class="hex-chat-rounds-opt" data-rounds="5" title="5è½®ï¼šå¤æ‚å†³ç­–ï¼Œå¤šè½®è¿­ä»£">5 è½®</button>
            </div>
          </span>
        </div>
        <div class="hex-chat-row" id="hexChatRow" style="display:none;">
          <input type="text" id="hexChatInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå‘æœ¬é¡¹ç›®å„å¦å‘é€â€¦" maxlength="2000" />
          <button type="button" class="hex-chat-send" id="hexChatSend">å‘é€</button>
        </div>
        <div class="hex-chat-toolbar" id="hexChatToolbar" style="display:none;">
          <span class="hex-chat-state" id="hexChatState"></span>
          <button type="button" class="hex-chat-clear-btn" id="hexChatClearSingle" title="åªæ¸…ç©ºç¾¤å‘å•èŠäº§ç”Ÿçš„æ¶ˆæ¯">æ¸…ç©ºå•èŠ</button>
          <button type="button" class="hex-chat-clear-btn" id="hexChatClearDiscuss" title="åªæ¸…ç©ºç¾¤è®¨è®ºäº§ç”Ÿçš„æ¶ˆæ¯">æ¸…ç©ºç¾¤èŠ</button>
          <button type="button" class="hex-chat-clear-btn" id="hexChatClearAll" title="æ¸…ç©ºå…¨éƒ¨ä¸å¦å¯¹è¯å†å²">æ¸…ç©ºå…¨éƒ¨</button>
          <button type="button" class="hex-chat-clear-btn" id="btnUpdateMemory" title="è®©é˜´æç‚¼æœ¬æ¬¡å¯¹è¯çš„å…³é”®å†…å®¹ï¼Œå­˜å…¥é¡¹ç›®è®°å¿†">ğŸ“ æ›´æ–°è®°å¿†</button>
          <button type="button" class="hex-chat-clear-btn" id="btnShowFiles" title="æŸ¥çœ‹æœ¬é¡¹ç›®å„å¦çš„äº§å‡ºæ–‡ä»¶">ğŸ“ äº§å‡ºæ–‡ä»¶</button>
          <button type="button" class="hex-chat-clear-btn" id="btnDispatchTask" title="æŠŠå½“å‰è®¨è®ºå†…å®¹ä½œä¸ºèƒŒæ™¯ï¼Œæ´¾å‘æ‰§è¡Œä»»åŠ¡ç»™æŒ‡å®šå¦">âš¡ æ´¾å‘ä»»åŠ¡</button>
        </div>
        <!-- æ´¾å‘ä»»åŠ¡é¢æ¿ -->
        <div id="dispatchPanel" style="display:none;">
          <div class="dispatch-panel">
            <div class="dispatch-panel-title">âš¡ æ´¾å‘æ‰§è¡Œä»»åŠ¡ <span style="font-size:0.72rem; color:var(--text-dim); font-weight:400;">ï¼ˆå¦å°†é€šè¿‡å·¥å…·çœŸå®æ‰§è¡Œï¼Œå†™æ–‡ä»¶/è¿è¡Œå‘½ä»¤ç­‰ï¼‰</span></div>
            <div class="dispatch-context-label">è®¨è®ºèƒŒæ™¯ï¼ˆè‡ªåŠ¨æå–ï¼Œå¯å¿½ç•¥ï¼‰ï¼š</div>
            <div class="dispatch-context" id="dispatchContext"></div>
            <textarea class="dispatch-instruction" id="dispatchInstruction" placeholder="è¾“å…¥å…·ä½“æ‰§è¡ŒæŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼šæ ¹æ®ä¸Šé¢çš„è®¨è®ºï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ PRD æ–‡æ¡£ï¼Œä¿å­˜åˆ° output/ ç›®å½•"></textarea>
            <div style="font-size:0.78rem; color:var(--text-dim); margin-bottom:6px;">é€‰æ‹©æ‰§è¡Œå¦ï¼š</div>
            <div class="dispatch-hex-list" id="dispatchHexList"></div>
            <div class="dispatch-actions">
              <button type="button" class="dispatch-send-btn" id="dispatchSendBtn">æ´¾å‘</button>
              <button type="button" class="dispatch-cancel-btn" id="dispatchCancelBtn">å–æ¶ˆ</button>
              <span class="dispatch-status" id="dispatchStatus"></span>
            </div>
          </div>
        </div>
        <!-- äº§å‡ºæ–‡ä»¶é¢æ¿ -->
        <div id="projectFilesPanel" style="display:none; margin:8px 0; border:1px solid rgba(201,162,39,0.25); border-radius:8px; background:rgba(201,162,39,0.03); padding:10px 14px;">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <span style="font-size:0.82rem; color:var(--gold-dim); font-weight:500;">ğŸ“ é¡¹ç›®äº§å‡ºæ–‡ä»¶</span>
            <div style="display:flex; gap:8px;">
              <button type="button" class="hex-chat-clear-btn" id="btnRefreshFiles" style="padding:2px 8px; font-size:0.75rem;">åˆ·æ–°</button>
              <button type="button" class="hex-chat-clear-btn" id="btnCloseFiles" style="padding:2px 8px; font-size:0.75rem;">å…³é—­</button>
            </div>
          </div>
          <div id="projectFilesList" style="font-size:0.8rem; color:var(--text-dim); max-height:180px; overflow-y:auto;"></div>
        </div>
        <div class="hex-chat-status" id="hexChatStatus"></div>
        <div class="hex-chat-messages" id="hexChatMessages"></div>
      </section>

      <div class="chat-resizer" id="chatResizer"></div>
      <section class="section-yin-chat" id="panelYinChat">
        <h2>ä¸é˜´å¯¹è¯<button type="button" class="yin-chat-clear-btn" id="yinChatClearBtn">æ¸…ç©ºè®°å½•</button></h2>
        <p class="yin-chat-hint">æ­¤å¤„å¯¹è¯ä»…å±äºå½“å‰é¡¹ç›®</p>
        <div class="yin-chat-row">
          <input type="text" id="yinChatInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œä¸é˜´æ€»æ§å¯¹è¯â€¦" maxlength="2000" />
          <button type="button" class="yin-chat-send" id="yinChatSend">å‘é€</button>
        </div>
        <div class="yin-chat-messages" id="yinChatMessages"></div>
      </section>
    </div>

    <div class="toast" id="toast"></div>
  </div>
  <script>
    (function initStarfield() {
      var container = document.getElementById('starfield');
      if (!container) return;
      for (var i = 0; i < 40; i++) {
        var el = document.createElement('div');
        el.className = 'star';
        el.style.left = (Math.random() * 100) + '%';
        el.style.top = (Math.random() * 100) + '%';
        el.style.width = (1 + Math.random() * 2) + 'px';
        el.style.height = el.style.width;
        el.style.opacity = 0.4 + Math.random() * 0.4;
        el.style.setProperty('--dur', (1.5 + Math.random() * 2) + 's');
        el.style.setProperty('--delay', (Math.random() * 2) + 's');
        container.appendChild(el);
      }
    })();

    var projectId = (function() {
      var m = /[?&]id=([^&]+)/.exec(window.location.search);
      return m ? decodeURIComponent(m[1]) : '';
    })();
    var nameEl = document.getElementById('projectName');
    var breadcrumbSep = document.getElementById('breadcrumbSep');
    var breadcrumbProject = document.getElementById('breadcrumbProject');
    var ringEl = document.getElementById('ringHexes');
    var emptyHint = document.getElementById('emptyRingHint');
    var taijiActions = document.getElementById('taijiActions');
    var btnOpenSelectHex = document.getElementById('btnOpenSelectHex');
    var modalSelectHex = document.getElementById('modalSelectHex');
    var selectHexGrid = document.getElementById('selectHexGrid');
    var modalBtnDone = document.getElementById('modalBtnDone');
    var toast = document.getElementById('toast');
    var hexChatEmpty = document.getElementById('hexChatEmpty');
    var hexChatFileWarn = document.getElementById('hexChatFileWarn');
    var hexChatModeRow = document.getElementById('hexChatModeRow');
    var hexChatStatus = document.getElementById('hexChatStatus');
    var sectionHexSwitches = document.getElementById('sectionHexSwitches');
    var hexSwitchesEl = document.getElementById('hexSwitches');
    var hexChatRow = document.getElementById('hexChatRow');
    var hexChatInput = document.getElementById('hexChatInput');
    var hexChatSend = document.getElementById('hexChatSend');
    var hexChatMessages = document.getElementById('hexChatMessages');
    var yinChatInput = document.getElementById('yinChatInput');
    var yinChatSend = document.getElementById('yinChatSend');
    var yinChatMessages = document.getElementById('yinChatMessages');
    var chatResizer = document.getElementById('chatResizer');
    var chatSectionsContainer = document.querySelector('.chat-sections-container');
    var sectionHexChat = document.querySelector('.section-hex-chat');
    var sectionYinChat = document.querySelector('.section-yin-chat');

    var project = null;
    var hexList = [];
    var robots = [];

    // å¯æ‹–åŠ¨åˆ†éš”çº¿é€»è¾‘
    (function() {
      var CHAT_SPLIT_KEY = 'chat_split_ratio';
      var isResizing = false;
      var startX = 0;
      var startLeftWidth = 0;

      function loadSplitRatio() {
        try {
          var saved = localStorage.getItem(CHAT_SPLIT_KEY);
          if (saved) {
            var ratio = parseFloat(saved);
            if (ratio > 0 && ratio < 1) return ratio;
          }
        } catch (e) {}
        return 0.5; // é»˜è®¤ 50%
      }

      function saveSplitRatio(ratio) {
        try {
          localStorage.setItem(CHAT_SPLIT_KEY, String(ratio));
        } catch (e) {}
      }

      function setSplitRatio(ratio) {
        if (!chatSectionsContainer || !sectionHexChat || !sectionYinChat) return;
        var containerWidth = chatSectionsContainer.clientWidth;
        var leftWidth = containerWidth * ratio;
        sectionHexChat.style.flex = '0 0 ' + leftWidth + 'px';
        sectionYinChat.style.flex = '1';
      }

      function handleMouseDown(e) {
        if (!chatSectionsContainer || !sectionHexChat) return;
        isResizing = true;
        startX = e.clientX;
        startLeftWidth = sectionHexChat.offsetWidth;
        if (chatResizer) chatResizer.classList.add('resizing');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      }

      function handleMouseMove(e) {
        if (!isResizing || !chatSectionsContainer || !sectionHexChat) return;
        var containerWidth = chatSectionsContainer.clientWidth;
        var deltaX = e.clientX - startX;
        var newLeftWidth = Math.max(0, Math.min(containerWidth, startLeftWidth + deltaX));
        var ratio = newLeftWidth / containerWidth;
        setSplitRatio(ratio);
        saveSplitRatio(ratio);
        if (typeof window._onSplitDrag === 'function') window._onSplitDrag();
      }

      function handleMouseUp() {
        if (!isResizing) return;
        isResizing = false;
        if (chatResizer) chatResizer.classList.remove('resizing');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      }

      if (chatResizer && chatSectionsContainer) {
        chatResizer.addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        // åˆå§‹åŒ–æ—¶åŠ è½½ä¿å­˜çš„æ¯”ä¾‹
        window.addEventListener('load', function() {
          setTimeout(function() {
            var ratio = loadSplitRatio();
            setSplitRatio(ratio);
          }, 100);
        });
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—
        window.addEventListener('resize', function() {
          var ratio = loadSplitRatio();
          setSplitRatio(ratio);
        });
      }
      window._chatSetSplitRatio = setSplitRatio;
      window._chatLoadSplitRatio = loadSplitRatio;
    })();

    // å¸ƒå±€åˆ‡æ¢å™¨ï¼ˆ3ç‚¹ï¼šå…¨å¦ / å„åŠ / å…¨é˜´ï¼‰
    (function() {
      var panelHex = document.getElementById('panelHexChat');
      var panelYin = document.getElementById('panelYinChat');
      var resizer  = document.getElementById('chatResizer');
      var dotHex   = document.getElementById('dotHex');
      var dotHalf  = document.getElementById('dotHalf');
      var dotYin   = document.getElementById('dotYin');
      var LAYOUT_KEY = 'chat_layout_mode'; // 'hex' | 'half' | 'yin'

      function getMode() {
        try { return localStorage.getItem(LAYOUT_KEY) || 'half'; } catch(e) { return 'half'; }
      }
      function saveMode(m) {
        try { localStorage.setItem(LAYOUT_KEY, m); } catch(e) {}
      }

      function setPanel(el, opts) {
        if (!el) return;
        el.style.flex      = opts.flex;
        el.style.minWidth  = opts.minWidth  !== undefined ? opts.minWidth  : '0';
        el.style.maxWidth  = opts.maxWidth  !== undefined ? opts.maxWidth  : '100%';
        el.style.overflow  = 'hidden';
        el.style.padding   = opts.padding   !== undefined ? opts.padding   : '';
        el.style.border    = opts.border    !== undefined ? opts.border    : '';
      }

      function applyMode(mode) {
        [dotHex, dotHalf, dotYin].forEach(function(d) { if (d) d.classList.remove('active'); });
        if (mode === 'hex') {
          if (dotHex) dotHex.classList.add('active');
          setPanel(panelHex, { flex: '1 1 0' });
          setPanel(panelYin, { flex: '0 0 0px', minWidth: '0', maxWidth: '0', padding: '0', border: 'none' });
          if (resizer) resizer.style.display = 'none';
        } else if (mode === 'yin') {
          if (dotYin) dotYin.classList.add('active');
          setPanel(panelHex, { flex: '0 0 0px', minWidth: '0', maxWidth: '0', padding: '0', border: 'none' });
          setPanel(panelYin, { flex: '1 1 0' });
          if (resizer) resizer.style.display = 'none';
        } else {
          // ä¸­é—´ç‚¹ï¼šå¼ºåˆ¶ 50/50ï¼Œä¸­çº¿å¯è§å¯æ‹–åŠ¨
          if (dotHalf) dotHalf.classList.add('active');
          if (panelHex) { panelHex.style.padding = ''; panelHex.style.border = ''; panelHex.style.overflow = 'hidden'; panelHex.style.minWidth = '0'; panelHex.style.maxWidth = '100%'; }
          setPanel(panelYin, { flex: '1 1 0' });
          if (resizer) resizer.style.display = '';
          if (typeof window._chatSetSplitRatio === 'function') {
            setTimeout(function() { window._chatSetSplitRatio(0.5); }, 10);
          }
        }
      }

      if (dotHex)  dotHex.addEventListener('click',  function() { saveMode('hex');  applyMode('hex');  });
      if (dotHalf) dotHalf.addEventListener('click', function() { saveMode('half'); applyMode('half'); });
      if (dotYin)  dotYin.addEventListener('click',  function() { saveMode('yin');  applyMode('yin');  });

      // æ‹–åŠ¨ä¸­çº¿æ—¶è‡ªåŠ¨é«˜äº®ä¸­é—´ç‚¹
      window._onSplitDrag = function() {
        saveMode('half');
        [dotHex, dotHalf, dotYin].forEach(function(d) { if (d) d.classList.remove('active'); });
        if (dotHalf) dotHalf.classList.add('active');
      };

      window.addEventListener('load', function() {
        setTimeout(function() { applyMode(getMode()); }, 150);
      });

      window._applyLayoutMode = applyMode;
    })();

    // å æ»¡å±å¹• / é€€å‡ºå…¨å±
    (function() {
      var btn = document.getElementById('chatFullscreenToggle');
      if (!btn || !chatSectionsContainer) return;
      btn.addEventListener('click', function() {
        var isFull = chatSectionsContainer.classList.toggle('fullscreen');
        btn.textContent = isFull ? 'é€€å‡ºå…¨å±' : 'å›ºå®š';
        btn.title = isFull ? 'ç‚¹å‡»æ¢å¤é¡µé¢æ»šåŠ¨' : 'ç‚¹å‡»å›ºå®šä¸ºå…¨å±';
        if (isFull && typeof window._chatLoadSplitRatio === 'function' && typeof window._chatSetSplitRatio === 'function') {
          setTimeout(function() {
            var ratio = window._chatLoadSplitRatio();
            window._chatSetSplitRatio(ratio);
          }, 50);
        }
      });
    })();

    var isFileProtocol = window.location.protocol === 'file:';
    if (hexChatFileWarn && isFileProtocol) hexChatFileWarn.style.display = 'block';
    function setHexChatFormEnabled(enabled) {
      var on = enabled && !isFileProtocol;
      var hexPending = (typeof _activeTaskId !== 'undefined' && _activeTaskId != null) || (typeof _activeAgentTasks !== 'undefined' && _activeAgentTasks && _activeAgentTasks.size > 0) || (typeof _hexChatRestoring !== 'undefined' && _hexChatRestoring);
      if (hexChatSend) hexChatSend.disabled = !on || !!hexPending;
      if (hexChatInput) { hexChatInput.disabled = !on; hexChatInput.placeholder = on ? 'è¾“å…¥æ¶ˆæ¯ï¼Œå‘æœ¬é¡¹ç›®å„å¦å‘é€â€¦' : 'è¯·ç”¨ http://localhost:3999/project.html æ‰“å¼€é¡µé¢åå†å‘æ¶ˆæ¯'; }
    }

    function show(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    function escapeHtml(s) {
      var div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    function displayChar(name) {
      return name && name.length > 1 ? name.charAt(0) : (name || '');
    }

    var OUTER_RING_RADIUS_PCT = 48;

    function renderRing() {
      var hexIds = (project && project.hexIds) ? project.hexIds : [];
      var isEmpty = hexIds.length === 0;
      if (emptyHint) emptyHint.style.display = isEmpty ? 'block' : 'none';
      if (taijiActions) taijiActions.classList.toggle('empty', isEmpty);
      ringEl.innerHTML = '';
      if (hexIds.length === 0) return;
      var n = hexIds.length;
      var radiusPct = OUTER_RING_RADIUS_PCT;
      for (var i = 0; i < n; i++) {
        var hexId = hexIds[i];
        var hex = hexList.find(function(h) { return h.id === hexId; });
        var name = hex ? hex.name : hexId;
        var char = displayChar(name);
        var angle = (i / n) * 2 * Math.PI - Math.PI / 2;
        var x = 50 + radiusPct * Math.cos(angle);
        var y = 50 + radiusPct * Math.sin(angle);
        var div = document.createElement('div');
        div.className = 'ring-hex';
        div.style.left = x + '%';
        div.style.top = y + '%';
        div.textContent = char;
        ringEl.appendChild(div);
      }
    }

    function openSelectHexModal() {
      renderSelectHexGrid();
      modalSelectHex.classList.add('show');
      modalSelectHex.setAttribute('aria-hidden', 'false');
    }
    function closeSelectHexModal() {
      modalSelectHex.classList.remove('show');
      modalSelectHex.setAttribute('aria-hidden', 'true');
    }
    function renderSelectHexGrid() {
      var hexIds = (project && project.hexIds) ? project.hexIds : [];
      selectHexGrid.innerHTML = '';
      hexList.forEach(function(h) {
        var added = hexIds.indexOf(h.id) !== -1;
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'select-hex-btn' + (added ? ' added' : '');
        btn.textContent = h.name;
        btn.dataset.hexId = h.id;
        btn.addEventListener('click', function() { toggleHexInProject(h.id); });
        selectHexGrid.appendChild(btn);
      });
    }
    function toggleHexInProject(hexId) {
      if (!project) return;
      var hexIds = (project.hexIds || []).slice();
      var idx = hexIds.indexOf(hexId);
      if (idx !== -1) hexIds.splice(idx, 1);
      else hexIds.push(hexId);
      updateProjectHexIds(hexIds);
    }

    function updateProjectHexIds(hexIds) {
      fetch('/api/projects/' + encodeURIComponent(projectId), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hexIds: hexIds })
      })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(result) {
          if (result.ok) {
            project = result.data;
            renderRing();
            renderHexSwitches();
            // æ›´æ–°å¯¹è¯åŒºåŸŸçš„æ˜¾ç¤ºçŠ¶æ€
            var hasHex = (project.hexIds && project.hexIds.length) > 0;
            if (hexChatEmpty) hexChatEmpty.style.display = hasHex ? 'none' : 'block';
            if (hexChatModeRow) hexChatModeRow.style.display = hasHex ? 'flex' : 'none';
            if (hexChatRow) hexChatRow.style.display = hasHex ? 'flex' : 'none';
            var toolbar = document.getElementById('hexChatToolbar');
            if (toolbar) toolbar.style.display = hasHex ? 'flex' : 'none';
            setHexChatFormEnabled(hasHex);
            updateHexChatState();
            if (modalSelectHex.classList.contains('show')) renderSelectHexGrid();
            updateHexChatModeUI();
            updateHexChatRoundsUI();
            show('å·²æ›´æ–°');
          } else {
            show(result.data.error || 'æ›´æ–°å¤±è´¥');
          }
        })
        .catch(function() { show('è¯·æ±‚å¤±è´¥'); });
    }

    btnOpenSelectHex.addEventListener('click', openSelectHexModal);
    modalBtnDone.addEventListener('click', closeSelectHexModal);
    modalSelectHex.addEventListener('click', function(e) {
      if (e.target === modalSelectHex) closeSelectHexModal();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modalSelectHex.classList.contains('show')) closeSelectHexModal();
    });

    function renderHexSwitches() {
      if (!hexSwitchesEl || !sectionHexSwitches) return;
      var hexIds = (project && project.hexIds) ? project.hexIds : [];
      if (hexIds.length === 0) {
        sectionHexSwitches.style.display = 'none';
        return;
      }
      sectionHexSwitches.style.display = 'block';
      hexSwitchesEl.innerHTML = '';
      hexIds.forEach(function(hexId) {
        var robot = robots.find(function(r) { return r.id === hexId; });
        var name = (robot && robot.name) ? robot.name : hexId;
        var running = !!(robot && robot.running);
        var item = document.createElement('div');
        item.className = 'hex-switch-item' + (running ? ' running' : '');
        item.innerHTML =
          '<span class="hex-name">' + escapeHtml(name) + '</span>' +
          '<span class="hex-status">' + (running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢') + '</span>' +
          (running
            ? '<button type="button" class="btn-hex-action stop" data-robot="' + escapeHtml(hexId) + '">åœæ­¢</button>'
            : '<button type="button" class="btn-hex-action start" data-robot="' + escapeHtml(hexId) + '">å¯åŠ¨</button>');
        var btn = item.querySelector('.btn-hex-action');
        if (btn) {
          btn.addEventListener('click', function() {
            var rid = btn.dataset.robot;
            if (!rid) return;
            btn.disabled = true;
            var url = btn.classList.contains('stop') ? '/api/stop/' + encodeURIComponent(rid) : '/api/open-tui/' + encodeURIComponent(rid);
            var method = 'POST';
            fetch(url, { method: method })
              .then(function() { return fetch('/api/robots').then(function(r) { return r.json(); }); })
              .then(function(list) {
                robots = list || [];
                renderHexSwitches();
                show(btn.classList.contains('stop') ? 'å·²å‘é€åœæ­¢' : 'å·²å‘é€å¯åŠ¨');
              })
              .catch(function() { show('è¯·æ±‚å¤±è´¥'); })
              .then(function() { btn.disabled = false; });
          });
        }
        hexSwitchesEl.appendChild(item);
      });
    }

    // ä¸€é”®å¯åŠ¨/åœæ­¢æœ¬é¡¹ç›®æ‰€æœ‰å¦
    var btnStartAllHex = document.getElementById('btnStartAllHex');
    var btnStopAllHex = document.getElementById('btnStopAllHex');

    function batchHexAction(action) {
      if (!project || !project.hexIds || project.hexIds.length === 0) return;
      var hexIds = project.hexIds.slice();
      var btn = action === 'start' ? btnStartAllHex : btnStopAllHex;
      if (btn) btn.disabled = true;
      var promises = hexIds.map(function(hexId) {
        var url = action === 'stop'
          ? '/api/stop/' + encodeURIComponent(hexId)
          : '/api/open-tui/' + encodeURIComponent(hexId);
        return fetch(url, { method: 'POST' }).catch(function() {});
      });
      Promise.all(promises).then(function() {
        return fetch('/api/robots?nocache=1').then(function(r) { return r.json(); });
      }).then(function(list) {
        robots = list || [];
        hexList = robots.filter(function(r) { return r.id !== 'main' && r.id !== 'lan'; });
        renderHexSwitches();
        renderRing();
        show(action === 'start' ? 'å·²å‘é€ä¸€é”®å¯åŠ¨' : 'å·²å‘é€ä¸€é”®åœæ­¢');
      }).catch(function() {
        show('è¯·æ±‚å¤±è´¥');
      }).then(function() {
        if (btn) btn.disabled = false;
      });
    }

    if (btnStartAllHex) btnStartAllHex.addEventListener('click', function() { batchHexAction('start'); });
    if (btnStopAllHex) btnStopAllHex.addEventListener('click', function() { batchHexAction('stop'); });

    // æ›´æ–°é¡¹ç›®è®°å¿†ï¼šè®©é˜´æç‚¼è¿‘æœŸå¯¹è¯å…³é”®å†…å®¹ï¼Œè¿½åŠ åˆ°é¡¹ç›®è®°å¿†æ–‡ä»¶
    var btnUpdateMemory = document.getElementById('btnUpdateMemory');
    if (btnUpdateMemory) {
      btnUpdateMemory.addEventListener('click', function() {
        if (!projectId) return;
        // æ”¶é›†æœ€è¿‘çš„æ‘˜è¦å’Œå†³ç­–æ–‡æœ¬
        var summaryTexts = [];
        if (hexChatMessages) {
          hexChatMessages.querySelectorAll('.hex-chat-summary-block').forEach(function(block) {
            var s = block.getAttribute('data-summary') || (block.querySelector('.hex-chat-summary-content') || {}).textContent || '';
            if (s) summaryTexts.push('ã€æ‘˜è¦ã€‘' + s.trim());
            var d = block.querySelector('.hex-chat-yin-decision');
            if (d) {
              var dt = d.getAttribute('data-decision') || (d.querySelector('.hex-chat-summary-content') || {}).textContent || '';
              if (dt) summaryTexts.push('ã€å†³ç­–ã€‘' + dt.trim());
            }
          });
        }
        if (summaryTexts.length === 0) {
          alert('æ²¡æœ‰æ‰¾åˆ°æ‘˜è¦æˆ–å†³ç­–å†…å®¹ï¼Œè¯·å…ˆè¿›è¡Œç¾¤è®¨è®ºå¹¶ç”Ÿæˆæ‘˜è¦ã€‚');
          return;
        }
        var prompt = 'ä»¥ä¸‹æ˜¯æœ¬é¡¹ç›®æœ€è¿‘çš„è®¨è®ºæ‘˜è¦å’Œå†³ç­–è®°å½•ï¼š\n\n' + summaryTexts.join('\n\n') +
          '\n\nè¯·æç‚¼å‡º2-5æ¡å…³é”®ä¿¡æ¯ï¼Œæ¯æ¡æ ¼å¼ä¸ºï¼š"ç±»å‹|å†…å®¹"ï¼Œç±»å‹åªèƒ½æ˜¯ï¼šå†³ç­–/è¿›å±•/é£é™©/å¾…åŠ ä¹‹ä¸€ã€‚' +
          'å†…å®¹ä¸è¶…è¿‡50å­—ã€‚åªè¾“å‡ºåˆ—è¡¨ï¼Œä¸è¦å¤šä½™çš„è¯ã€‚ä¾‹å¦‚ï¼š\nå†³ç­–|é‡‡ç”¨Python+Whisperæ–¹æ¡ˆåšå­—å¹•\nè¿›å±•|ä¹¾å®Œæˆå­—å¹•ç”Ÿæˆæ¨¡å—';
        btnUpdateMemory.disabled = true;
        btnUpdateMemory.textContent = 'ğŸ“ æç‚¼ä¸­â€¦';
        fetch('/api/yin/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: prompt, projectId: projectId, history: [] })
        }).then(function(r) { return r.json(); }).then(function(data) {
          var reply = data.reply || '';
          // è§£æé˜´çš„è¾“å‡ºï¼šæ¯è¡Œ"ç±»å‹|å†…å®¹"
          var lines = reply.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l.includes('|'); });
          if (lines.length === 0) {
            alert('é˜´æœªèƒ½æç‚¼å‡ºæœ‰æ•ˆè®°å¿†ï¼ŒåŸå§‹å›å¤ï¼š\n' + reply);
            return;
          }
          var promises = lines.map(function(line) {
            var parts = line.split('|');
            var type = parts[0].trim();
            var content = parts.slice(1).join('|').trim();
            if (!content) return Promise.resolve();
            return fetch('/api/project-memory/' + encodeURIComponent(projectId), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: type, content: content })
            });
          });
          Promise.all(promises).then(function() {
            btnUpdateMemory.textContent = 'ğŸ“ å·²æ›´æ–° ' + lines.length + ' æ¡è®°å¿†';
            setTimeout(function() { btnUpdateMemory.textContent = 'ğŸ“ æ›´æ–°è®°å¿†'; }, 3000);
          });
        }).catch(function() {
          alert('è®°å¿†æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥é˜´æ˜¯å¦åœ¨çº¿');
        }).then(function() {
          btnUpdateMemory.disabled = false;
          if (btnUpdateMemory.textContent === 'ğŸ“ æç‚¼ä¸­â€¦') btnUpdateMemory.textContent = 'ğŸ“ æ›´æ–°è®°å¿†';
        });
      });
    }

    // ä¸å¦å¯¹è¯å†å²ç®¡ç†
    // P1: å•èŠ/ç¾¤èŠå„è‡ªç‹¬ç«‹çš„å­˜å‚¨ keyï¼Œäº’ä¸å¹²æ‰°
    var HEX_CHAT_STORAGE_KEY_PREFIX = 'hex_chat_history_project_';
    var HEX_CHAT_MODE_KEY_PREFIX = 'hex_chat_mode_project_';

    function getHexChatStorageKey(modeOverride) {
      if (!projectId) return null;
      var mode = modeOverride || getHexChatMode();
      // å•èŠå’Œç¾¤èŠå„è‡ªç‹¬ç«‹çš„ key
      return HEX_CHAT_STORAGE_KEY_PREFIX + projectId + '_' + mode;
    }
    function getHexChatModeKey() {
      return projectId ? HEX_CHAT_MODE_KEY_PREFIX + projectId : null;
    }
    function getHexChatMode() {
      var key = getHexChatModeKey();
      if (!key) return 'discuss';
      try {
        var v = localStorage.getItem(key);
        return (v === 'single' || v === 'discuss' || v === 'agent') ? v : 'discuss';
      } catch (e) { return 'discuss'; }
    }
    function setHexChatMode(mode) {
      var key = getHexChatModeKey();
      if (!key || (mode !== 'single' && mode !== 'discuss' && mode !== 'agent')) return;
      try { localStorage.setItem(key, mode); } catch (e) {}
    }
    function updateHexChatModeUI() {
      var mode = getHexChatMode();
      document.querySelectorAll('input[name="hexChatMode"]').forEach(function(r) { r.checked = (r.value === mode); });
      var isAgent = mode === 'agent';
      if (hexChatInput) hexChatInput.placeholder = isAgent
        ? 'è¾“å…¥ä»»åŠ¡æŒ‡ä»¤ï¼Œç”¨ @å¦å æŒ‡å®šæ‰§è¡Œçš„å¦ï¼ˆå¦‚ @ä¹¾ å¸®æˆ‘å†™ä¸€é¦–è¯—å­˜åˆ°æ–‡ä»¶ï¼‰â€¦'
        : 'è¾“å…¥æ¶ˆæ¯ï¼Œå‘æœ¬é¡¹ç›®å„å¦å‘é€â€¦';
    }
    var HEX_CHAT_ROUNDS_KEY_PREFIX = 'hex_chat_max_rounds_project_';
    function getHexChatMaxRoundsKey() { return projectId ? HEX_CHAT_ROUNDS_KEY_PREFIX + projectId : null; }
    function getHexChatMaxRounds() {
      var key = getHexChatMaxRoundsKey();
      if (!key) return 2;
      try { var v = parseInt(localStorage.getItem(key), 10); return (v >= 1 && v <= 5) ? v : 2; } catch (e) { return 2; }
    }
    function setHexChatMaxRounds(n) {
      var key = getHexChatMaxRoundsKey();
      if (!key || n < 1 || n > 5) return;
      try { localStorage.setItem(key, String(n)); } catch (e) {}
    }
    var hexChatRoundsBtn = document.getElementById('hexChatRoundsBtn');
    var hexChatRoundsValue = document.getElementById('hexChatRoundsValue');
    var hexChatRoundsPopover = document.getElementById('hexChatRoundsPopover');
    function updateHexChatRoundsUI() {
      var mode = getHexChatMode();
      var isDiscuss = mode === 'discuss';
      var isAgent = mode === 'agent';
      var n = isDiscuss ? getHexChatMaxRounds() : 1;
      if (hexChatRoundsValue) hexChatRoundsValue.textContent = n;
      if (hexChatRoundsBtn) {
        hexChatRoundsBtn.classList.toggle('disabled', !isDiscuss);
        hexChatRoundsBtn.title = isDiscuss ? 'é€‰æ‹©è®¨è®ºè½®æ•°ï¼ˆ1=ä»…é¦–è½®ï¼Œ2=é¦–è½®+äº’ç›¸çœ‹å›å¤ï¼Œ3=å†åŠ ä¸€è½®è¡¥å……ï¼‰' : (isAgent ? 'æ‰§è¡Œä»»åŠ¡æ¨¡å¼ä¸ä½¿ç”¨è½®æ¬¡' : 'ç¾¤å‘å•èŠå›ºå®š 1 è½®');
      }
      var roundsWrap = document.getElementById('hexChatRoundsWrap');
      if (roundsWrap) roundsWrap.style.display = isAgent ? 'none' : '';
      if (hexChatRoundsPopover) {
        hexChatRoundsPopover.querySelectorAll('.hex-chat-rounds-opt').forEach(function(btn) {
          btn.classList.toggle('active', parseInt(btn.getAttribute('data-rounds'), 10) === n);
        });
      }
    }

    function updateHexChatState() {
      var el = document.getElementById('hexChatState');
      if (!el) return;
      var mode = getHexChatMode();
      var isDiscuss = mode === 'discuss';
      var isAgent = mode === 'agent';
      var n = isDiscuss ? getHexChatMaxRounds() : 1;
      var participants = (project && project.hexIds && project.hexIds.length) ? project.hexIds.length + ' å¦' : '';
      if (isAgent) {
        el.textContent = 'âš¡ æ‰§è¡Œä»»åŠ¡æ¨¡å¼' + (participants ? ' Â· ' + participants : '');
      } else {
        el.textContent = isDiscuss ? ('ç¾¤è®¨è®º Â· ' + n + ' è½®' + (participants ? ' Â· ' + participants : '')) : ('ç¾¤å‘å•èŠ' + (participants ? ' Â· ' + participants : ''));
      }
    }

    // é˜¶æ®µ2.1ï¼šå†…å­˜ç¼“å­˜ï¼Œé¿å…æ¯æ¬¡éƒ½è¯»æœåŠ¡å™¨
    var _hexChatCache = {}; // { 'discuss': [...], 'single': [...] }

    function saveHexChatHistory() {
      var currentMode = getHexChatMode();
      if (!projectId || !hexChatMessages) return;
      var messages = [];
      // æ”¶é›†æ™®é€šèŠå¤©æ°”æ³¡
      hexChatMessages.querySelectorAll('.hex-chat-msg').forEach(function(msg) {
        var hexName = msg.querySelector('.hex-name');
        var name = hexName ? hexName.textContent.trim() : '';
        var text = msg.getAttribute('data-message');
        if (text == null) text = msg.textContent.replace(name, '').replace(/^[å•ç¾¤]\s*/, '').replace(/\s*åˆ†äº«åˆ°ç¾¤èŠ\s*$/, '').trim();
        var isError = msg.classList.contains('err');
        if (!text) return;
        var type = name === 'ä½ ' ? 'user' : (name === 'ç³»ç»Ÿ' ? 'system' : 'hex');
        messages.push({ type: type, name: name === 'ä½ ' ? null : name, message: text, isError: isError, mode: currentMode });
      });
      // æ”¶é›†æ‘˜è¦å¡ç‰‡
      hexChatMessages.querySelectorAll('.hex-chat-summary-block').forEach(function(block) {
        var summaryText = block.getAttribute('data-summary');
        var hexName = block.getAttribute('data-hex-name') || '';
        if (!summaryText) {
          var contentEl = block.querySelector('.hex-chat-summary-content');
          summaryText = contentEl ? contentEl.textContent.trim() : '';
        }
        if (summaryText) messages.push({ type: 'summary', hexName: hexName, message: summaryText, mode: currentMode });
        // æ”¶é›†å†³ç­–å¡ç‰‡ï¼ˆåµŒå¥—åœ¨æ‘˜è¦å¡ç‰‡é‡Œï¼‰
        var decisionBlock = block.querySelector('.hex-chat-yin-decision');
        if (decisionBlock) {
          var decisionText = decisionBlock.getAttribute('data-decision');
          if (!decisionText) {
            var contentEl2 = decisionBlock.querySelector('.hex-chat-summary-content');
            decisionText = contentEl2 ? contentEl2.textContent.trim() : '';
          }
          if (decisionText) messages.push({ type: 'decision', message: decisionText, mode: currentMode });
        }
      });
      // æ›´æ–°å†…å­˜ç¼“å­˜
      _hexChatCache[currentMode] = messages;
      // å¼‚æ­¥ä¿å­˜åˆ°æœåŠ¡å™¨
      fetch('/api/chat-history/' + encodeURIComponent(projectId) + '/' + currentMode, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: messages })
      }).catch(function(e) { console.warn('ä¿å­˜å¦å¯¹è¯å†å²åˆ°æœåŠ¡å™¨å¤±è´¥:', e); });
      try { localStorage.setItem(getHexChatStorageKey(currentMode), JSON.stringify(messages)); } catch (e) {}
    }

    function loadHexChatHistory() {
      var currentMode = getHexChatMode();
      if (!projectId || !hexChatMessages) return;
      // ä¼˜å…ˆç”¨å†…å­˜ç¼“å­˜ï¼ˆåˆ‡æ¢æ¨¡å¼æ—¶é¿å…é‡å¤è¯·æ±‚ï¼‰
      if (_hexChatCache[currentMode]) {
        _renderHexChatMessages(_hexChatCache[currentMode], currentMode);
        return;
      }
      // ä»æœåŠ¡å™¨åŠ è½½
      fetch('/api/chat-history/' + encodeURIComponent(projectId) + '/' + currentMode)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var messages = data.messages || [];
          // æœåŠ¡å™¨æ— è®°å½•æ—¶ï¼Œå°è¯•ä» localStorage è¿ç§»
          if (messages.length === 0) {
            try {
              var local = localStorage.getItem(getHexChatStorageKey(currentMode));
              if (local) {
                messages = JSON.parse(local);
                // è‡ªåŠ¨è¿ç§»åˆ°æœåŠ¡å™¨
                if (messages.length > 0) {
                  fetch('/api/chat-history/' + encodeURIComponent(projectId) + '/' + currentMode, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messages })
                  }).catch(function() {});
                }
              }
            } catch (e) {}
          }
          _hexChatCache[currentMode] = messages;
          _renderHexChatMessages(messages, currentMode);
        })
        .catch(function(e) {
          console.warn('ä»æœåŠ¡å™¨åŠ è½½å¦å¯¹è¯å†å²å¤±è´¥ï¼Œé™çº§åˆ° localStorage:', e);
          try {
            var local = localStorage.getItem(getHexChatStorageKey(currentMode));
            if (local) _renderHexChatMessages(JSON.parse(local), currentMode);
          } catch (e2) {}
        });
    }

    function _renderHexChatMessages(messages, currentMode) {
      if (!hexChatMessages) return;
      // æŠŠ summary å’Œ decision é…å¯¹ï¼šsummary åé¢ç´§è·Ÿçš„ decision å½’å±äºå®ƒ
      var i = 0;
      while (i < messages.length) {
        var msg = messages[i];
        if (msg.type === 'summary') {
          // æ¸²æŸ“æ‘˜è¦å¡ç‰‡ï¼ˆåªè¯»ï¼Œä¸ç»‘æ¢äºº/æŒ‰é’®ï¼‰
          var summaryDiv = document.createElement('div');
          summaryDiv.className = 'hex-chat-summary-block';
          summaryDiv.setAttribute('data-summary', msg.message || '');
          summaryDiv.setAttribute('data-hex-name', msg.hexName || '');
          var label = msg.hexName ? 'ğŸ“‹ ' + escapeHtml(msg.hexName) + ' çš„è®¨è®ºæ‘˜è¦ï¼ˆå†å²ï¼‰' : 'ğŸ“‹ è®¨è®ºæ‘˜è¦ï¼ˆå†å²ï¼‰';
          summaryDiv.innerHTML =
            '<div class="hex-chat-summary-label">' + label + '</div>' +
            '<div class="hex-chat-summary-content">' + escapeHtml(msg.message || '') + '</div>';
          // æ£€æŸ¥ä¸‹ä¸€æ¡æ˜¯å¦æ˜¯é…å¯¹çš„ decision
          if (i + 1 < messages.length && messages[i + 1].type === 'decision') {
            i++;
            var decisionMsg = messages[i];
            var decisionDiv = document.createElement('div');
            decisionDiv.className = 'hex-chat-yin-decision';
            decisionDiv.setAttribute('data-decision', decisionMsg.message || '');
            var parsed = parseYinDecision(decisionMsg.message || '');
            decisionDiv.innerHTML = renderYinDecision(parsed, decisionMsg.message || '');
            summaryDiv.appendChild(decisionDiv);
          }
          hexChatMessages.appendChild(summaryDiv);
        } else if (msg.type === 'decision') {
          // ç‹¬ç«‹çš„ decisionï¼ˆæ²¡æœ‰é…å¯¹çš„ summaryï¼‰ï¼Œå•ç‹¬æ¸²æŸ“
          var decisionDiv2 = document.createElement('div');
          decisionDiv2.className = 'hex-chat-yin-decision';
          decisionDiv2.setAttribute('data-decision', msg.message || '');
          var parsed2 = parseYinDecision(msg.message || '');
          decisionDiv2.innerHTML = renderYinDecision(parsed2, msg.message || '');
          hexChatMessages.appendChild(decisionDiv2);
        } else {
          var name = msg.name || (msg.type === 'user' ? 'ä½ ' : 'ç³»ç»Ÿ');
          var msgMode = msg.mode || currentMode;
          appendHexChatMsg(name, msg.message, msg.isError || false, false, msgMode);
        }
        i++;
      }
    }

    function clearHexChatHistoryByMode(mode) {
      if (!projectId) return;
      var modesToClear = mode === 'all' ? ['single', 'discuss'] : [mode];
      modesToClear.forEach(function(m) {
        _hexChatCache[m] = [];
        try { localStorage.removeItem(getHexChatStorageKey(m)); } catch (e) {}
        fetch('/api/chat-history/' + encodeURIComponent(projectId) + '/' + m, { method: 'DELETE' })
          .catch(function(e) { console.warn('æ¸…ç©ºæœåŠ¡å™¨å†å²å¤±è´¥:', e); });
      });
      if (hexChatMessages) {
        hexChatMessages.innerHTML = '';
        loadHexChatHistory();
      }
    }

    function getHexChatHistory() {
      var currentMode = getHexChatMode();
      try {
        // ä»å†…å­˜ç¼“å­˜è¯»ï¼ˆsaveHexChatHistory åç¼“å­˜å·²æ˜¯æœ€æ–°ï¼‰
        var messages = _hexChatCache[currentMode] || [];
        if (messages.length === 0) {
          // ç¼“å­˜ä¸ºç©ºæ—¶é™çº§åˆ° localStorageï¼ˆåŒæ­¥è¯»ï¼Œé¿å…å¼‚æ­¥é—®é¢˜ï¼‰
          var local = localStorage.getItem(getHexChatStorageKey(currentMode));
          if (local) messages = JSON.parse(local);
        }
        if (messages.length > 0) {
          var filtered = messages.filter(function(msg) {
            var t = msg && msg.type;
            if (t !== 'user' && t !== 'hex') return false;
            // ç¾¤å‘å•èŠï¼šåªä¼ ç”¨æˆ·æ¶ˆæ¯ï¼Œå¦ä¸èƒ½çœ‹åˆ°å…¶ä»–å¦çš„å›å¤
            if (currentMode === 'single') return t === 'user';
            return true;
          });
          return filtered.map(function(msg) {
            return { type: msg.type, name: msg.name || null, message: msg.message };
          });
        }
      } catch (e) {
        console.warn('è·å–å¦å¯¹è¯å†å²å¤±è´¥:', e);
      }
      return [];
    }

    function shareToDiscuss(hexName, message) {
      // åˆ†äº«åˆ°ç¾¤èŠï¼šå†™å…¥ç¾¤è®¨è®ºæ¨¡å¼çš„ç‹¬ç«‹å­˜å‚¨
      var key = getHexChatStorageKey('discuss');
      if (!key) return;
      try {
        var stored = localStorage.getItem(key) || '[]';
        var messages = JSON.parse(stored);
        var type = hexName === 'ä½ ' ? 'user' : 'hex';
        messages.push({ type: type, name: hexName === 'ä½ ' ? null : hexName, message: message, isError: false, mode: 'discuss' });
        localStorage.setItem(key, JSON.stringify(messages));
        if (getHexChatMode() === 'discuss' && hexChatMessages) {
          appendHexChatMsg(hexName, message, false, false, 'discuss');
        }
      } catch (e) { console.warn('åˆ†äº«åˆ°ç¾¤èŠå¤±è´¥:', e); }
    }
    // P4: ç¾¤è®¨è®ºç»“æŸåï¼Œè®©ç¬¬ä¸€ä¸ªå¦åšè®¨è®ºæ‘˜è¦
    function triggerDiscussSummary(hexIds, replies) {
      if (!hexIds || !hexIds.length) return;
      var summaryHexId = hexIds[0];
      var summaryHex = hexList.find(function(h) { return h.id === summaryHexId; });
      var summaryHexName = summaryHex ? summaryHex.name : summaryHexId;
      // æ„å»ºæ‘˜è¦ promptï¼šæŠŠæœ¬æ¬¡è®¨è®ºçš„å„å¦å›å¤ä¼ ç»™ç¬¬ä¸€ä¸ªå¦
      var discussContent = replies.filter(function(r) { return r.reply; }).map(function(r) {
        return r.name + 'ï¼š' + r.reply;
      }).join('\n\n');
      if (!discussContent) return;
      var summaryPrompt = 'ä»¥ä¸‹æ˜¯åˆšåˆšçš„ç¾¤è®¨è®ºå†…å®¹ï¼š\n\n' + discussContent + '\n\nè¯·ä½ ä½œä¸ºæ±‡æŠ¥è€…ï¼Œå®¢è§‚æ•´ç†ä»¥ä¸Šè®¨è®ºçš„æ ¸å¿ƒè§‚ç‚¹å’Œåˆ†æ­§ï¼Œä¸åŠ å…¥ä½ è‡ªå·±çš„åˆ¤æ–­ï¼ˆåˆ¤æ–­ç•™ç»™ç®¡ç†è€…ï¼‰ã€‚æ ¼å¼ï¼šæ ¸å¿ƒè§‚ç‚¹ï¼ˆæ¯äººä¸€å¥ï¼‰ã€åˆ†æ­§ç‚¹ï¼ˆå¦‚æœ‰ï¼‰ã€‚ç®€æ´ï¼Œä¸è¶…è¿‡200å­—ã€‚';

      // æ˜¾ç¤ºæ‘˜è¦åŒºåŸŸå ä½
      var summaryDiv = document.createElement('div');
      summaryDiv.className = 'hex-chat-summary-block';
      summaryDiv.innerHTML = '<div class="hex-chat-summary-label">ğŸ“‹ ' + escapeHtml(summaryHexName) + ' æ­£åœ¨æ•´ç†æ‘˜è¦â€¦</div>';
      if (hexChatMessages) {
        hexChatMessages.appendChild(summaryDiv);
        hexChatMessages.scrollTop = hexChatMessages.scrollHeight;
      }

      doSummaryRequest(summaryHexId, summaryHexName, summaryPrompt, summaryDiv, hexIds, replies);
    }

    // å†…éƒ¨ï¼šæ‰§è¡Œæ‘˜è¦è¯·æ±‚ï¼ˆæ”¯æŒé‡æ–°ç”Ÿæˆæ—¶æ¢å¦ï¼‰
    // æ‘˜è¦æ¸²æŸ“ï¼šæŠŠæ‘˜è¦æ–‡æœ¬å¡«å…¥ summaryDivï¼Œç»‘å®šæ¢äºº/è¯·é˜´æŒ‰é’®
    function _renderSummaryReply(reply, hexId, hexName, summaryDiv, hexIds, replies) {
      var regenSelect = '';
      if (hexIds && hexIds.length > 1) {
        regenSelect = '<select class="hex-chat-regen-select" title="æ¢ä¸€ä¸ªå¦é‡æ–°ç”Ÿæˆæ‘˜è¦">';
        hexIds.forEach(function(hid) {
          var h = hexList.find(function(x) { return x.id === hid; });
          var hn = h ? h.name : hid;
          regenSelect += '<option value="' + escapeHtml(hid) + '"' + (hid === hexId ? ' selected' : '') + '>' + escapeHtml(hn) + '</option>';
        });
        regenSelect += '</select>';
      }
      // æŠŠæ‘˜è¦å†…å®¹å­˜ä¸º data å±æ€§ï¼ŒsaveHexChatHistory è¯»å–æ—¶ç”¨
      summaryDiv.setAttribute('data-summary', reply);
      summaryDiv.setAttribute('data-hex-name', hexName);
      summaryDiv.innerHTML =
        '<div class="hex-chat-summary-label">ğŸ“‹ ' + escapeHtml(hexName) + ' çš„è®¨è®ºæ‘˜è¦' +
        (regenSelect ? '<span class="hex-chat-regen-wrap"> Â· æ¢äººæ‘˜è¦ï¼š' + regenSelect + '</span>' : '') +
        '</div>' +
        '<div class="hex-chat-summary-content">' + escapeHtml(reply) + '</div>' +
        '<div class="hex-chat-summary-actions">' +
        '<button type="button" class="hex-chat-ask-yin-btn">@é˜´ è¯·æ±‚å†³ç­–</button>' +
        '</div>';
      var regenSelectEl = summaryDiv.querySelector('.hex-chat-regen-select');
      if (regenSelectEl) {
        regenSelectEl.addEventListener('change', function() {
          var newHexId = this.value;
          var newHex = hexList.find(function(h) { return h.id === newHexId; });
          var newHexName = newHex ? newHex.name : newHexId;
          var discussContent = (replies || []).filter(function(r) { return r.reply; }).map(function(r) {
            return r.name + 'ï¼š' + r.reply;
          }).join('\n\n');
          var newPrompt = 'ä»¥ä¸‹æ˜¯åˆšåˆšçš„ç¾¤è®¨è®ºå†…å®¹ï¼š\n\n' + discussContent + '\n\nè¯·ä½ ä½œä¸ºæ±‡æŠ¥è€…ï¼Œå®¢è§‚æ•´ç†ä»¥ä¸Šè®¨è®ºçš„æ ¸å¿ƒè§‚ç‚¹å’Œåˆ†æ­§ï¼Œä¸åŠ å…¥ä½ è‡ªå·±çš„åˆ¤æ–­ã€‚æ ¼å¼ï¼šæ ¸å¿ƒè§‚ç‚¹ï¼ˆæ¯äººä¸€å¥ï¼‰ã€åˆ†æ­§ç‚¹ï¼ˆå¦‚æœ‰ï¼‰ã€‚ç®€æ´ï¼Œä¸è¶…è¿‡200å­—ã€‚';
          doSummaryRequest(newHexId, newHexName, newPrompt, summaryDiv, hexIds, replies);
        });
      }
      var yinBtn = summaryDiv.querySelector('.hex-chat-ask-yin-btn');
      if (yinBtn) {
        yinBtn.addEventListener('click', function() {
          triggerYinDecision(reply, summaryDiv);
        });
      }
      if (hexChatMessages) hexChatMessages.scrollTop = hexChatMessages.scrollHeight;
      // æ‘˜è¦å®Œæˆåå­˜å…¥å†å²
      saveHexChatHistory();
    }

    function doSummaryRequest(hexId, hexName, prompt, summaryDiv, hexIds, replies) {
      summaryDiv.innerHTML = '<div class="hex-chat-summary-label">ğŸ“‹ ' + escapeHtml(hexName) + ' æ­£åœ¨æ•´ç†æ‘˜è¦â€¦</div>';
      if (hexChatMessages) hexChatMessages.scrollTop = hexChatMessages.scrollHeight;

      function showSummaryError(msg) {
        if (!summaryDiv) return;
        summaryDiv.innerHTML =
          '<div class="hex-chat-summary-label">ğŸ“‹ ' + escapeHtml(msg) +
          ' <button type="button" class="hex-chat-summary-retry">é‡è¯•</button></div>';
        var retryBtn = summaryDiv.querySelector('.hex-chat-summary-retry');
        if (retryBtn) retryBtn.addEventListener('click', function() {
          doSummaryRequest(hexId, hexName, prompt, summaryDiv, hexIds, replies);
        });
      }

      function pollSummaryTask(taskId) {
        fetch('/api/hex/task/' + taskId)
          .then(function(r) { return r.json(); })
          .then(function(task) {
            if (task.status === 'done') {
              var reply = task.replies && task.replies[0] && task.replies[0].reply;
              if (reply) {
                _renderSummaryReply(reply, hexId, hexName, summaryDiv, hexIds, replies);
              } else {
                showSummaryError('æ‘˜è¦è·å–å¤±è´¥');
              }
            } else if (task.status === 'error') {
              showSummaryError('æ‘˜è¦è·å–å¤±è´¥ï¼š' + (task.error || 'æœªçŸ¥é”™è¯¯'));
            } else {
              setTimeout(function() { pollSummaryTask(taskId); }, 2000);
            }
          })
          .catch(function() { setTimeout(function() { pollSummaryTask(taskId); }, 3000); });
      }

      fetch('/api/hex/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: prompt,
          hexIds: [hexId],
          history: [],
          enableBroadcast: false,
          maxRounds: 1,
          projectId: projectId
        })
      }).then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.taskId) {
            pollSummaryTask(data.taskId);
          } else {
            showSummaryError('æ‘˜è¦è·å–å¤±è´¥');
          }
        })
        .catch(function() { showSummaryError('æ‘˜è¦è·å–å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯'); });
    }

    // P4: è§¦å‘é˜´å†³ç­–ï¼ˆè‡ªåŠ¨ + æ‰‹åŠ¨é‡è¯•å‡èµ°æ­¤å‡½æ•°ï¼‰ï¼›ä¸é˜´å¯¹è¯å·²æ”¹ä¸º taskId+è½®è¯¢ï¼Œæ­¤å¤„åŒæ­¥æ”¹ä¸ºè½®è¯¢å–å›å¤
    function triggerYinDecision(summaryText, summaryDiv) {
      var yinBtn = summaryDiv && summaryDiv.querySelector('.hex-chat-ask-yin-btn');
      if (yinBtn) { yinBtn.disabled = true; yinBtn.textContent = 'é˜´æ­£åœ¨å†³ç­–â€¦'; }
      if (summaryDiv) {
        var oldDecision = summaryDiv.querySelector('.hex-chat-yin-decision');
        if (oldDecision) oldDecision.remove();
      }
      var yinHistory = getYinChatHistoryForAPI();
      var yinPrompt = 'ä»¥ä¸‹æ˜¯é¡¹ç›®å¦ç¾¤çš„è®¨è®ºæ‘˜è¦ï¼š\n\n' + summaryText + '\n\nè¯·ä½ ä½œä¸ºé¡¹ç›®ç®¡ç†è€…ï¼Œä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼ç»™å‡ºå†³ç­–ï¼ˆæ¯ä¸ªæ ‡ç­¾å¿…é¡»æœ‰å†…å®¹ï¼‰ï¼š\n\nå†³ç­–ï¼šæ‰§è¡Œ / æš‚ç¼“ / æ”¾å¼ƒï¼ˆä¸‰é€‰ä¸€ï¼‰\nç½®ä¿¡åº¦ï¼šé«˜ / ä¸­ / ä½ï¼ˆä¸‰é€‰ä¸€ï¼‰\nç†ç”±ï¼šï¼ˆ1-3å¥è¯ï¼Œç®€æ´æœ‰åŠ›ï¼‰\nè¡ŒåŠ¨é¡¹ï¼šï¼ˆè°è´Ÿè´£ä»€ä¹ˆï¼Œæ ¼å¼ï¼š- è´Ÿè´£äººï¼šä»»åŠ¡å†…å®¹ï¼‰\n\nè¦æ±‚ï¼šä¸¥æ ¼æŒ‰æ ¼å¼ï¼Œä¸è¦å¤šä½™å†…å®¹ï¼Œä¸è¶…è¿‡200å­—ã€‚';

      function renderDecisionResult(reply, errMsg) {
        if (!summaryDiv) return;
        var decisionDiv = document.createElement('div');
        decisionDiv.className = 'hex-chat-yin-decision';
        if (reply) {
          decisionDiv.setAttribute('data-decision', reply);
          var parsed = parseYinDecision(reply);
          decisionDiv.innerHTML = renderYinDecision(parsed, reply);
          var copyBtn = decisionDiv.querySelector('.hex-chat-decision-copy');
          if (copyBtn) {
            copyBtn.addEventListener('click', function() {
              navigator.clipboard && navigator.clipboard.writeText(reply).then(function() {
                copyBtn.textContent = 'å·²å¤åˆ¶âœ“'; setTimeout(function() { copyBtn.textContent = 'å¤åˆ¶å†³ç­–'; }, 2000);
              });
            });
          }
          saveHexChatHistory();
        } else if (errMsg && errMsg.indexOf('æœªé…ç½®') !== -1) {
          decisionDiv.innerHTML = '<div class="hex-chat-summary-label">ğŸŒ‘ é˜´å¯¹è¯æœªé…ç½®ï¼Œæ— æ³•è·å–å†³ç­–</div>';
        } else {
          decisionDiv.innerHTML = '<div class="hex-chat-summary-label">ğŸŒ‘ é˜´çš„å†³ç­–è·å–å¤±è´¥ <button type="button" class="hex-chat-ask-yin-btn">é‡è¯•</button></div>';
          var retryBtn = decisionDiv.querySelector('.hex-chat-ask-yin-btn');
          if (retryBtn) retryBtn.addEventListener('click', function() { triggerYinDecision(summaryText, summaryDiv); });
        }
        summaryDiv.appendChild(decisionDiv);
        if (hexChatMessages) hexChatMessages.scrollTop = hexChatMessages.scrollHeight;
        var btnAfter = summaryDiv && summaryDiv.querySelector('.hex-chat-ask-yin-btn');
        if (btnAfter) { btnAfter.disabled = false; btnAfter.textContent = '@é˜´ è¯·æ±‚å†³ç­–'; }
      }

      fetch('/api/yin/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: yinPrompt, projectId: projectId, history: yinHistory })
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var taskId = data && data.taskId;
          if (!taskId) {
            renderDecisionResult(null, data && data.error ? data.error : 'æœªè¿”å› taskId');
            return;
          }
          function poll() {
            fetch('/api/yin/task/' + encodeURIComponent(taskId))
              .then(function(r) { return r.json(); })
              .then(function(task) {
                if (task.status === 'done') {
                  renderDecisionResult(task.reply || null, null);
                  return;
                }
                if (task.status === 'error') {
                  renderDecisionResult(null, task.error || 'æœªçŸ¥é”™è¯¯');
                  return;
                }
                setTimeout(poll, 1500);
              })
              .catch(function() { setTimeout(poll, 2000); });
          }
          poll();
        })
        .catch(function() {
          if (summaryDiv) {
            var decisionDiv = document.createElement('div');
            decisionDiv.className = 'hex-chat-yin-decision';
            decisionDiv.innerHTML = '<div class="hex-chat-summary-label">ğŸŒ‘ é˜´çš„å†³ç­–è·å–å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯</div>';
            summaryDiv.appendChild(decisionDiv);
          }
          var btnAfter = summaryDiv && summaryDiv.querySelector('.hex-chat-ask-yin-btn');
          if (btnAfter) { btnAfter.disabled = false; btnAfter.textContent = '@é˜´ è¯·æ±‚å†³ç­–'; }
        });
    }

    // P6: è§£æé˜´çš„ç»“æ„åŒ–å†³ç­–æ–‡æœ¬
    function parseYinDecision(text) {
      var result = { decision: '', confidence: '', reason: '', actions: '', raw: text };
      var lines = text.split('\n');
      var currentKey = null;
      var buffer = [];
      lines.forEach(function(line) {
        var m;
        if ((m = line.match(/^å†³ç­–[ï¼š:]\s*(.+)/))) { result.decision = m[1].trim(); currentKey = null; }
        else if ((m = line.match(/^ç½®ä¿¡åº¦[ï¼š:]\s*(.+)/))) { result.confidence = m[1].trim(); currentKey = null; }
        else if ((m = line.match(/^ç†ç”±[ï¼š:]\s*(.*)/))) { buffer = [m[1]]; currentKey = 'reason'; }
        else if ((m = line.match(/^è¡ŒåŠ¨é¡¹[ï¼š:]\s*(.*)/))) {
          if (currentKey === 'reason') result.reason = buffer.join('\n').trim();
          buffer = [m[1]]; currentKey = 'actions';
        } else if (currentKey) {
          buffer.push(line);
        }
      });
      if (currentKey === 'reason') result.reason = buffer.join('\n').trim();
      if (currentKey === 'actions') result.actions = buffer.join('\n').trim();
      return result;
    }

    // P6: æ¸²æŸ“ç»“æ„åŒ–å†³ç­–ä¸º HTML
    function renderYinDecision(parsed, rawText) {
      var decisionColor = { 'æ‰§è¡Œ': '#4caf82', 'æš‚ç¼“': '#f0a020', 'æ”¾å¼ƒ': '#e05a5a' }[parsed.decision] || 'var(--gold)';
      var confidenceIcon = { 'é«˜': 'ğŸŸ¢', 'ä¸­': 'ğŸŸ¡', 'ä½': 'ğŸ”´' }[parsed.confidence] || 'âšª';
      var html = '<div class="hex-chat-summary-label">ğŸŒ‘ é˜´ Â· å†³ç­–æ€»ç»“' +
        '<button type="button" class="hex-chat-decision-copy" style="margin-left:8px;font-size:11px;padding:1px 6px;">å¤åˆ¶å†³ç­–</button>' +
        '</div>';
      if (parsed.decision) {
        html += '<div class="hex-chat-decision-main" style="display:flex;align-items:center;gap:12px;padding:10px 0 6px;">' +
          '<span class="hex-chat-decision-verdict" style="font-size:20px;font-weight:700;color:' + decisionColor + ';">' + escapeHtml(parsed.decision) + '</span>' +
          (parsed.confidence ? '<span style="font-size:13px;">' + confidenceIcon + ' ç½®ä¿¡åº¦ï¼š' + escapeHtml(parsed.confidence) + '</span>' : '') +
          '</div>';
        if (parsed.reason) html += '<div style="font-size:13px;color:var(--text-muted);margin-bottom:6px;line-height:1.5;">' + escapeHtml(parsed.reason).replace(/\n/g, '<br>') + '</div>';
        if (parsed.actions) html += '<div style="font-size:13px;border-top:1px solid rgba(255,255,255,.08);padding-top:6px;">' +
          '<strong style="color:var(--text-muted);font-size:11px;">è¡ŒåŠ¨é¡¹</strong><br>' +
          escapeHtml(parsed.actions).replace(/\n/g, '<br>') + '</div>';
      } else {
        // æ— æ³•è§£æç»“æ„ï¼Œç›´æ¥æ˜¾ç¤ºåŸæ–‡
        html += '<div class="hex-chat-summary-content">' + escapeHtml(rawText) + '</div>';
      }
      return html;
    }

    function renderMd(text) {
      if (typeof marked !== 'undefined') {
        try {
          return '<span class="hex-chat-md">' + marked.parse(String(text || ''), { breaks: true, gfm: true }) + '</span>';
        } catch(e) {}
      }
      return escapeHtml(text || '').replace(/\n/g, '<br>');
    }
    function appendHexChatMsg(hexName, reply, isError, save, mode) {
      if (save === undefined) save = true;
      if (!mode) mode = getHexChatMode();
      var div = document.createElement('div');
      div.className = 'hex-chat-msg' + (isError ? ' err' : '');
      div.setAttribute('data-mode', mode);
      div.setAttribute('data-name', hexName);
      div.setAttribute('data-message', reply || '');
      var safeName = escapeHtml(hexName);
      var isUser = (hexName === 'ä½ ');
      var replyHtml = isError || isUser ? escapeHtml(reply || '').replace(/\n/g, '<br>') : renderMd(reply);
      var modeLabel = mode === 'single' ? '<span class="hex-chat-mode-tag" title="ç¾¤å‘å•èŠ">å•</span>' : '<span class="hex-chat-mode-tag" title="ç¾¤è®¨è®º">ç¾¤</span>';
      var shareBtn = mode === 'single' ? ' <span class="hex-chat-share" title="å°†æœ¬æ¡åŒæ­¥åˆ°ç¾¤è®¨è®ºä¸Šä¸‹æ–‡">åˆ†äº«åˆ°ç¾¤èŠ</span>' : '';
      div.innerHTML = '<span class="hex-name">' + safeName + '</span>' + modeLabel + replyHtml + shareBtn;
      hexChatMessages.appendChild(div);
      hexChatMessages.scrollTop = hexChatMessages.scrollHeight;
      if (save) saveHexChatHistory();
    }
    function setHexChatStatus(html) {
      if (!hexChatStatus) return;
      hexChatStatus.innerHTML = html || '';
      hexChatStatus.classList.toggle('show', !!html);
    }
    var currentRequestAbortController = null;
    // ç”¨ taskId è½®è¯¢ç­‰å¾…æœåŠ¡ç«¯ä»»åŠ¡å®Œæˆï¼Œä½¿å¾—åˆ‡æ¢é¡µé¢ä¸ä¼šä¸­æ–­è¯·æ±‚
    var _activeTaskId = null;
    var _activeTaskTimer = null;
    var _hexChatRestoring = false; // æ­£åœ¨ä» localStorage æ¢å¤å¦ä»»åŠ¡æ—¶ä¸º trueï¼Œé¿å… setHexChatFormEnabled æŠŠå‘é€é’®é‡æ–°å¯ç”¨
    var _activeEnableBroadcast = false;
    var _activeHexIds = [];
    function _onHexChatDone(replies, enableBroadcast, hexIds) {
      var statusParts = [];
      replies.forEach(function(r) {
        if (r.reply) statusParts.push('<span class="st-item st-ok">' + escapeHtml(r.name) + ' æˆåŠŸ</span>');
        else statusParts.push('<span class="st-item st-fail">' + escapeHtml(r.name) + ' å¤±è´¥ï¼š' + escapeHtml(r.error || 'â€”') + '</span>');
      });
      setHexChatStatus(statusParts.length ? statusParts.join(' ') : '');
      var allFailed = replies.length > 0;
      replies.forEach(function(r) {
        if (r.reply) allFailed = false;
        appendHexChatMsg(r.name, r.reply || r.error || 'â€”', !!r.error);
      });
      if (allFailed && replies.length > 0) {
        appendHexChatMsg('ç³»ç»Ÿ', 'å½“å‰æ‰€é€‰å¦å‡æ— æ³•è¿æ¥ã€‚è¯·åœ¨æœ¬é¡µã€Œæœ¬é¡¹ç›®å¦è±¡ Â· å¯åœã€å¤„å¯¹éœ€è¦å¯¹è¯çš„å¦ç‚¹å‡»ã€Œå¯åŠ¨ã€ï¼Œç­‰å¾…æ˜¾ç¤ºä¸ºè¿è¡Œä¸­åå†å‘æ¶ˆæ¯ã€‚', true, false);
      }
      var successReplies = replies.filter(function(r) { return r.reply; });
      if (enableBroadcast && !allFailed && successReplies.length >= 2) {
        triggerDiscussSummary(hexIds, replies);
      }
      hexChatSend.disabled = false;
      _activeTaskId = null;
    }
    function _pollTask(taskId, enableBroadcast, hexIds) {
      if (_activeTaskId !== taskId) return; // å·²åˆ‡èµ°ï¼Œåœæ­¢è½®è¯¢ï¼ˆä½†æœåŠ¡ç«¯ä»åœ¨è·‘ï¼‰
      fetch('/api/hex/task/' + taskId)
        .then(function(r) { return r.json(); })
        .then(function(task) {
          if (_activeTaskId !== taskId) return;
          if (task.status === 'done') {
            _onHexChatDone(task.replies || [], enableBroadcast, hexIds);
          } else if (task.status === 'error') {
            setHexChatStatus('');
            appendHexChatMsg('ç³»ç»Ÿ', 'æœåŠ¡å¼‚å¸¸ï¼š' + (task.error || 'æœªçŸ¥é”™è¯¯'), true, false);
            hexChatSend.disabled = false;
            _activeTaskId = null;
          } else {
            // ä»åœ¨è¿è¡Œï¼Œ2ç§’åå†æŸ¥
            _activeTaskTimer = setTimeout(function() { _pollTask(taskId, enableBroadcast, hexIds); }, 2000);
          }
        })
        .catch(function() {
          if (_activeTaskId !== taskId) return;
          _activeTaskTimer = setTimeout(function() { _pollTask(taskId, enableBroadcast, hexIds); }, 3000);
        });
    }

    // â”€â”€â”€ Agent ä»»åŠ¡è½®è¯¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var _activeAgentTasks = new Set(); // æ”¯æŒå¹¶è¡Œå¤šä»»åŠ¡è½®è¯¢
    var _activeAgentTaskId = null; // å‘åå…¼å®¹
    var _activeAgentTaskTimer = null;

    function _pollAgentTask(taskId, hexName) {
      _activeAgentTasks.add(taskId);
      _activeAgentTaskId = taskId;
      fetch('/api/hex/agent-task/' + taskId)
        .then(function(r) { return r.json(); })
        .then(function(task) {
          if (!_activeAgentTasks.has(taskId)) return;
          if (task.status === 'done') {
            _activeAgentTasks.delete(taskId);
            if (_activeAgentTaskId === taskId) _activeAgentTaskId = null;
            if (_activeAgentTasks.size === 0) setHexChatStatus('');
            appendHexChatMsg(hexName || task.hexName || 'å¦', task.reply || 'ï¼ˆä»»åŠ¡å·²æ‰§è¡Œï¼Œæ— æ–‡å­—å›å¤ï¼‰', false, true, 'discuss');
            if (_activeAgentTasks.size === 0) hexChatSend.disabled = false;
            saveHexChatHistory();
          } else if (task.status === 'error') {
            _activeAgentTasks.delete(taskId);
            if (_activeAgentTaskId === taskId) _activeAgentTaskId = null;
            if (_activeAgentTasks.size === 0) setHexChatStatus('');
            appendHexChatMsg('ç³»ç»Ÿ', 'æ‰§è¡Œä»»åŠ¡å¤±è´¥ï¼š' + (task.error || 'æœªçŸ¥é”™è¯¯'), true, false);
            if (_activeAgentTasks.size === 0) hexChatSend.disabled = false;
          } else {
            var elapsed = task.createdAt ? Math.round((Date.now() - task.createdAt) / 1000) : 0;
            setHexChatStatus('âš¡ ' + (hexName || 'å¦') + ' æ­£åœ¨æ‰§è¡Œä»»åŠ¡â€¦ (' + elapsed + 's)');
            _activeAgentTaskTimer = setTimeout(function() { _pollAgentTask(taskId, hexName); }, 2000);
          }
        })
        .catch(function() {
          if (!_activeAgentTasks.has(taskId)) return;
          _activeAgentTaskTimer = setTimeout(function() { _pollAgentTask(taskId, hexName); }, 3000);
        });
    }

    // è§£ææ¶ˆæ¯ä¸­ @å¦åï¼Œè¿”å›å¯¹åº” hexId æ•°ç»„
    function parseMentionedHexNamesFromText(text, hexIds) {
      if (!text || !hexIds) return [];
      var result = [];
      for (var i = 0; i < hexList.length; i++) {
        var h = hexList[i];
        if (hexIds.indexOf(h.id) < 0) continue;
        if (text.indexOf('@' + h.name) >= 0) result.push(h.id);
      }
      return result;
    }

    // â”€â”€â”€ äº§å‡ºæ–‡ä»¶é¢æ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var projectFilesPanel = document.getElementById('projectFilesPanel');
    var projectFilesList = document.getElementById('projectFilesList');
    var btnShowFiles = document.getElementById('btnShowFiles');
    var btnRefreshFiles = document.getElementById('btnRefreshFiles');
    var btnCloseFiles = document.getElementById('btnCloseFiles');

    function loadProjectFiles() {
      if (!projectId || !projectFilesList) return;
      projectFilesList.innerHTML = '<span style="color:var(--text-dim)">åŠ è½½ä¸­â€¦</span>';
      fetch('/api/project-files/' + encodeURIComponent(projectId))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var files = data.files || [];
          if (files.length === 0) {
            projectFilesList.innerHTML = '<span style="color:var(--text-dim)">æš‚æ— äº§å‡ºæ–‡ä»¶ã€‚å¦æ‰§è¡Œä»»åŠ¡åï¼Œæ–‡ä»¶å°†å‡ºç°åœ¨å„è‡ª workspace/output/' + escapeHtml(projectId) + '/ ç›®å½•ã€‚</span>';
            return;
          }
          var html = files.map(function(f) {
            var size = f.size < 1024 ? f.size + 'B' : f.size < 1048576 ? (f.size / 1024).toFixed(1) + 'KB' : (f.size / 1048576).toFixed(1) + 'MB';
            var mtime = new Date(f.mtime).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            var dlUrl = '/api/project-files/' + encodeURIComponent(projectId) + '/download?hexId=' + encodeURIComponent(f.hexId) + '&path=' + encodeURIComponent(f.path);
            return '<div style="display:flex; align-items:center; gap:8px; padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.05);">'
              + '<span style="color:var(--gold-dim); min-width:28px; text-align:center;">' + escapeHtml(f.hexName) + '</span>'
              + '<span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="' + escapeHtml(f.path) + '">' + escapeHtml(f.name) + '</span>'
              + '<span style="color:var(--text-dim); min-width:44px; text-align:right;">' + size + '</span>'
              + '<span style="color:var(--text-dim); min-width:72px; text-align:right;">' + mtime + '</span>'
              + '<a href="' + dlUrl + '" download="' + escapeHtml(f.name) + '" style="color:var(--gold); text-decoration:none; padding:1px 6px; border:1px solid rgba(201,162,39,0.3); border-radius:3px; font-size:0.72rem;" title="ä¸‹è½½">â†“</a>'
              + '</div>';
          }).join('');
          projectFilesList.innerHTML = html;
        })
        .catch(function() {
          if (projectFilesList) projectFilesList.innerHTML = '<span style="color:var(--text-dim)">åŠ è½½å¤±è´¥</span>';
        });
    }

    if (btnShowFiles) {
      btnShowFiles.addEventListener('click', function() {
        if (!projectFilesPanel) return;
        var showing = projectFilesPanel.style.display !== 'none';
        projectFilesPanel.style.display = showing ? 'none' : '';
        if (!showing) loadProjectFiles();
      });
    }
    if (btnRefreshFiles) btnRefreshFiles.addEventListener('click', loadProjectFiles);
    if (btnCloseFiles) {
      btnCloseFiles.addEventListener('click', function() {
        if (projectFilesPanel) projectFilesPanel.style.display = 'none';
      });
    }

    // â”€â”€â”€ æ´¾å‘ä»»åŠ¡é¢æ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var btnDispatchTask = document.getElementById('btnDispatchTask');
    var dispatchPanel = document.getElementById('dispatchPanel');
    var dispatchContext = document.getElementById('dispatchContext');
    var dispatchInstruction = document.getElementById('dispatchInstruction');
    var dispatchHexList = document.getElementById('dispatchHexList');
    var dispatchSendBtn = document.getElementById('dispatchSendBtn');
    var dispatchCancelBtn = document.getElementById('dispatchCancelBtn');
    var dispatchStatus = document.getElementById('dispatchStatus');

    function buildDiscussContext() {
      // ä»å½“å‰è®¨è®ºæ¨¡å¼ç¼“å­˜é‡Œæå–æœ€è¿‘è‹¥å¹²æ¡æ‹¼æˆæ‘˜è¦èƒŒæ™¯
      var msgs = _hexChatCache['discuss'] || [];
      if (!msgs.length) {
        // å°è¯•å…¶ä»–æ¨¡å¼
        msgs = _hexChatCache['single'] || [];
      }
      var lines = [];
      msgs.forEach(function(m) {
        if (!m.message) return;
        if (m.type === 'user') {
          lines.push('ã€ç”¨æˆ·ã€‘' + m.message.slice(0, 200));
        } else if (m.type === 'hex' && m.name) {
          lines.push('ã€' + m.name + 'ã€‘' + m.message.slice(0, 300));
        } else if (m.type === 'summary') {
          lines.push('ã€è®¨è®ºæ‘˜è¦ã€‘' + m.message.slice(0, 400));
        } else if (m.type === 'decision') {
          lines.push('ã€é˜´çš„å†³ç­–ã€‘' + m.message.slice(0, 400));
        }
      });
      // æœ€å¤šä¿ç•™æœ€è¿‘ 20 æ¡
      var recent = lines.slice(-20);
      return recent.join('\n');
    }

    function openDispatchPanel() {
      if (!dispatchPanel) return;
      // å¡«å……è®¨è®ºèƒŒæ™¯
      var ctx = buildDiscussContext();
      if (dispatchContext) dispatchContext.textContent = ctx || 'ï¼ˆå½“å‰æ— è®¨è®ºè®°å½•ï¼‰';
      // æ¸²æŸ“å¦åˆ—è¡¨
      if (dispatchHexList) {
        dispatchHexList.innerHTML = '';
        hexList.forEach(function(h) {
          var chip = document.createElement('label');
          chip.className = 'dispatch-hex-chip';
          chip.dataset.hexId = h.id;
          var cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = h.id;
          cb.addEventListener('change', function() {
            chip.classList.toggle('selected', cb.checked);
          });
          chip.appendChild(cb);
          chip.appendChild(document.createTextNode(h.name || h.id));
          dispatchHexList.appendChild(chip);
        });
      }
      if (dispatchInstruction) dispatchInstruction.value = '';
      if (dispatchStatus) dispatchStatus.textContent = '';
      dispatchPanel.style.display = '';
      if (dispatchInstruction) dispatchInstruction.focus();
    }

    function closeDispatchPanel() {
      if (dispatchPanel) dispatchPanel.style.display = 'none';
    }

    if (btnDispatchTask) {
      btnDispatchTask.addEventListener('click', function() {
        var showing = dispatchPanel && dispatchPanel.style.display !== 'none';
        if (showing) { closeDispatchPanel(); } else { openDispatchPanel(); }
      });
    }
    if (dispatchCancelBtn) dispatchCancelBtn.addEventListener('click', closeDispatchPanel);

    if (dispatchSendBtn) {
      dispatchSendBtn.addEventListener('click', async function() {
        var instruction = dispatchInstruction ? dispatchInstruction.value.trim() : '';
        if (!instruction) { if (dispatchStatus) dispatchStatus.textContent = 'è¯·è¾“å…¥ä»»åŠ¡æŒ‡ä»¤'; return; }
        var selectedIds = [];
        if (dispatchHexList) {
          dispatchHexList.querySelectorAll('input[type=checkbox]:checked').forEach(function(cb) {
            selectedIds.push(cb.value);
          });
        }
        if (!selectedIds.length) { if (dispatchStatus) dispatchStatus.textContent = 'è¯·è‡³å°‘é€‰ä¸€ä¸ªå¦'; return; }

        var ctx = dispatchContext ? dispatchContext.textContent : '';
        var fullMessage = ctx && ctx !== 'ï¼ˆå½“å‰æ— è®¨è®ºè®°å½•ï¼‰'
          ? 'ã€èƒŒæ™¯è®¨è®ºè®°å½•ã€‘\n' + ctx + '\n\nã€ä½ çš„æ‰§è¡Œä»»åŠ¡ã€‘\n' + instruction
          : instruction;

        dispatchSendBtn.disabled = true;
        if (dispatchStatus) dispatchStatus.textContent = 'æ´¾å‘ä¸­â€¦';

        var results = [];
        for (var i = 0; i < selectedIds.length; i++) {
          var hexId = selectedIds[i];
          var hex = hexList.find(function(h) { return h.id === hexId; });
          var hexName = hex ? hex.name : hexId;
          try {
            var resp = await fetch('/api/hex/agent-task', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ hexId: hexId, message: fullMessage, projectId: projectId, sessionKey: 'main' })
            });
            var data = await resp.json();
            if (data.taskId) {
              results.push({ hexId: hexId, hexName: hexName, taskId: data.taskId });
            } else {
              results.push({ hexId: hexId, hexName: hexName, error: data.error || 'æœªçŸ¥é”™è¯¯' });
            }
          } catch (e) {
            results.push({ hexId: hexId, hexName: hexName, error: e.message });
          }
        }

        dispatchSendBtn.disabled = false;
        closeDispatchPanel();

        // åˆ‡æ¢åˆ°ç¾¤è®¨è®ºè§†å›¾å¹¶è¿½åŠ ä»»åŠ¡æ¶ˆæ¯
        var modeRadio = document.querySelector('input[name="hexChatMode"][value="discuss"]');
        if (modeRadio && !modeRadio.checked) { modeRadio.checked = true; modeRadio.dispatchEvent(new Event('change')); }

        // æ˜¾ç¤ºæ´¾å‘çš„æŒ‡ä»¤
        appendHexChatMsg('ç”¨æˆ·', 'âš¡ æ´¾å‘ä»»åŠ¡ï¼š' + instruction, false, true, 'discuss');

        // è½®è¯¢æ¯ä¸ªä»»åŠ¡ç»“æœ
        results.forEach(function(r) {
          if (r.error) {
            appendHexChatMsg(r.hexName, 'âš¡ æ´¾å‘å¤±è´¥ï¼š' + r.error, true, true, 'discuss');
            return;
          }
          appendHexChatMsg(r.hexName, 'âš¡ æ­£åœ¨æ‰§è¡Œä»»åŠ¡â€¦', false, false, 'discuss');
          _pollAgentTask(r.taskId, r.hexName);
        });
      });
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // æ‰§è¡Œä»»åŠ¡æ¨¡å¼ï¼šæ˜¾ç¤º/éšè—è½®æ¬¡é€‰æ‹©å™¨
    document.querySelectorAll('input[name="hexChatMode"]').forEach(function(r) {
      r.addEventListener('change', function() {
        var isAgent = r.value === 'agent' && r.checked;
        var roundsWrap = document.getElementById('hexChatRoundsWrap');
        if (roundsWrap) roundsWrap.style.display = isAgent ? 'none' : '';
        if (r.checked) {
          if (r.value !== 'agent') setHexChatMode(r.value);
          if (hexChatInput) hexChatInput.placeholder = isAgent
            ? 'è¾“å…¥ä»»åŠ¡æŒ‡ä»¤ï¼Œç”¨ @å¦å æŒ‡å®šæ‰§è¡Œçš„å¦ï¼ˆå¦‚ @ä¹¾ å¸®æˆ‘å†™ä¸€é¦–è¯—å­˜åˆ°æ–‡ä»¶ï¼‰â€¦'
            : 'è¾“å…¥æ¶ˆæ¯ï¼Œå‘æœ¬é¡¹ç›®å„å¦å‘é€â€¦';
          updateHexChatRoundsUI();
          updateHexChatState();
        }
      });
    });

    if (hexChatSend) {
      hexChatSend.addEventListener('click', function() {
        var text = (hexChatInput && hexChatInput.value) ? hexChatInput.value.trim() : '';
        if (!text || !project || !project.hexIds || !project.hexIds.length) return;
        hexChatInput.value = '';
        var hexIds = project.hexIds;
        var checkedMode = document.querySelector('input[name="hexChatMode"]:checked');
        var chatModeVal = checkedMode ? checkedMode.value : getHexChatMode();

        // âš¡ æ‰§è¡Œä»»åŠ¡æ¨¡å¼ï¼šé€šè¿‡ WebSocket è®©å¦ä½¿ç”¨å·¥å…·æ‰§è¡Œä»»åŠ¡
        if (chatModeVal === 'agent') {
          // è§£æ @å¦åï¼Œå¿…é¡»æŒ‡å®šä¸€ä¸ªå¦
          var mentioned = parseMentionedHexNamesFromText(text, hexIds);
          var targetHexId = mentioned.length > 0 ? mentioned[0] : hexIds[0];
          var hex = hexList.find(function(h) { return h.id === targetHexId; }) || { name: targetHexId };
          appendHexChatMsg('ä½ ', '[ä»»åŠ¡] ' + text, false);
          hexChatSend.disabled = true;
          setHexChatStatus('âš¡ æ­£åœ¨è®© ' + hex.name + ' æ‰§è¡Œä»»åŠ¡ï¼ˆå·¥å…·æ¨¡å¼ï¼‰â€¦');
          fetch('/api/hex/agent-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hexId: targetHexId, message: text, projectId: projectId })
          })
            .then(function(r) { return r.json(); })
            .then(function(data) {
              if (data.error) {
                setHexChatStatus('');
                appendHexChatMsg('ç³»ç»Ÿ', 'æ‰§è¡Œä»»åŠ¡å¤±è´¥ï¼š' + data.error, true, false);
                hexChatSend.disabled = false;
                return;
              }
              var agentTaskId = data.taskId;
              _pollAgentTask(agentTaskId, hex.name);
            })
            .catch(function(e) {
              setHexChatStatus('');
              appendHexChatMsg('ç³»ç»Ÿ', 'è¯·æ±‚å¤±è´¥ï¼š' + (e.message || 'ç½‘ç»œé”™è¯¯'), true);
              hexChatSend.disabled = false;
            });
          return;
        }

        appendHexChatMsg('ä½ ', text, false);
        hexChatSend.disabled = true;
        setHexChatStatus('æ­£åœ¨å‘å„å¦å‘é€â€¦');
        var history = getHexChatHistory();
        var enableBroadcast = chatModeVal === 'discuss';
        var maxRounds = getHexChatMaxRounds();
        currentRequestAbortController = null;
        fetch('/api/hex/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, hexIds: hexIds, history: history, enableBroadcast: enableBroadcast, maxRounds: maxRounds, projectId: projectId })
        })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.error) {
              setHexChatStatus('<span class="st-fail">æœåŠ¡å¼‚å¸¸ï¼š' + escapeHtml(data.error) + '</span>');
              appendHexChatMsg('ç³»ç»Ÿ', 'æœåŠ¡å¼‚å¸¸ï¼š' + data.error, true, false);
              hexChatSend.disabled = false;
              return;
            }
            var taskId = data.taskId;
            if (!taskId) {
              appendHexChatMsg('ç³»ç»Ÿ', 'æœªæ”¶åˆ°ä»»åŠ¡ IDï¼Œè¯·æ£€æŸ¥æœåŠ¡ç«¯æ—¥å¿—ã€‚', true, false);
              hexChatSend.disabled = false;
              return;
            }
            _activeTaskId = taskId;
            _activeEnableBroadcast = enableBroadcast;
            _activeHexIds = hexIds;
            // ç«‹å³å¼€å§‹è½®è¯¢
            _pollTask(taskId, enableBroadcast, hexIds);
          })
          .catch(function(e) {
            setHexChatStatus('');
            var msg = e.message || 'ç½‘ç»œé”™è¯¯';
            var hint = 'è¯·æ±‚å¤±è´¥ï¼š' + msg;
            if (/load failed|failed to fetch|networkerror|network error/i.test(String(msg)) || msg === 'Load failed') {
              hint = 'æ— æ³•è¿æ¥åˆ°é¢æ¿æ¥å£ã€‚è¯·ç”¨æµè§ˆå™¨æ‰“å¼€ï¼šhttp://localhost:3999/project.html' + (projectId ? '?id=' + projectId : '') + ' ï¼Œå¹¶ç¡®ä¿å·²å¯åŠ¨é¢æ¿ï¼ˆåœ¨ panel-web ç›®å½•è¿è¡Œ node server.js æˆ–åŒå‡»ã€Œå¯åŠ¨é¢æ¿ã€ï¼‰ã€‚è‹¥å½“å‰æ˜¯ç”¨æ–‡ä»¶æ–¹å¼æ‰“å¼€çš„é¡µé¢ï¼Œè¯·æ”¹ç”¨ä¸Šè¿°åœ°å€æ‰“å¼€ã€‚';
            }
            appendHexChatMsg('ç³»ç»Ÿ', hint, true);
            hexChatSend.disabled = false;
          });
      });
    }
    if (hexChatInput) hexChatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') hexChatSend.click();
    });
    // åˆ‡æ¢é¡µé¢æ—¶ï¼ŒæŠŠæ­£åœ¨è¿›è¡Œçš„ taskId ä¿å­˜åˆ° localStorageï¼Œå›æ¥åæ¢å¤ç»“æœ
    (function() {
      var TASK_KEY = 'hexChatTask_' + projectId;

      function restoreTask(savedTask) {
        if (!savedTask || !savedTask.taskId) return;
        if (Date.now() - savedTask.ts > 300000) { // 5åˆ†é’Ÿè¶…æ—¶
          localStorage.removeItem(TASK_KEY);
          return;
        }
        _hexChatRestoring = true;
        if (hexChatSend) hexChatSend.disabled = true;
        setHexChatStatus('æ­£åœ¨ç­‰å¾…å¦çš„å›å¤â€¦');
        fetch('/api/hex/task/' + savedTask.taskId)
          .then(function(r) { return r.json(); })
          .then(function(task) {
            localStorage.removeItem(TASK_KEY);
            _hexChatRestoring = false;
            if (task.status === 'done') {
              // ä»»åŠ¡å·²å®Œæˆï¼ŒæœåŠ¡ç«¯å·²è‡ªåŠ¨ä¿å­˜å†å²ï¼Œæ¸…ç©ºå†…å­˜ç¼“å­˜åé‡æ–°ä»æœåŠ¡ç«¯åŠ è½½ï¼Œé¿å…é‡å¤è¿½åŠ 
              if (hexChatMessages) hexChatMessages.innerHTML = '';
              _hexChatCache['single'] = null;
              _hexChatCache['discuss'] = null;
              setHexChatStatus('');
              if (hexChatSend) hexChatSend.disabled = false;
              loadHexChatHistory();
            } else if (task.status === 'running') {
              // è¿˜åœ¨è·‘ï¼Œæ¢å¤è½®è¯¢
              setHexChatStatus('æ­£åœ¨ç­‰å¾…å¦çš„å›å¤â€¦ï¼ˆåå°è¿è¡Œä¸­ï¼‰');
              _activeTaskId = savedTask.taskId;
              _activeEnableBroadcast = savedTask.enableBroadcast || false;
              _activeHexIds = savedTask.hexIds || [];
              _pollTask(savedTask.taskId, savedTask.enableBroadcast, savedTask.hexIds);
            } else if (task.status === 'expired') {
              // æœåŠ¡é‡å¯å¯¼è‡´ä»»åŠ¡è¶…æ—¶
              appendHexChatMsg('ç³»ç»Ÿ', 'ä¸Šæ¬¡å‘é€çš„æ¶ˆæ¯å› æœåŠ¡é‡å¯è€Œè¶…æ—¶ï¼Œè¯·é‡æ–°å‘é€ã€‚', true, false);
              setHexChatStatus('');
              if (hexChatSend) hexChatSend.disabled = false;
            } else {
              // error æˆ–æœªçŸ¥çŠ¶æ€
              if (task.error) {
                appendHexChatMsg('ç³»ç»Ÿ', 'æœåŠ¡å¼‚å¸¸ï¼š' + task.error, true, false);
              }
              setHexChatStatus('');
              if (hexChatSend) hexChatSend.disabled = false;
            }
          })
          .catch(function() {
            _hexChatRestoring = false;
            localStorage.removeItem(TASK_KEY);
            setHexChatStatus('');
            if (hexChatSend) hexChatSend.disabled = false;
            if (hexChatMessages) hexChatMessages.innerHTML = '';
            _hexChatCache['single'] = null;
            _hexChatCache['discuss'] = null;
            loadHexChatHistory();
          });
      }

      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡
      var savedTask = null;
      try { savedTask = JSON.parse(localStorage.getItem(TASK_KEY) || 'null'); } catch(e) {}
      if (savedTask && savedTask.taskId) {
        restoreTask(savedTask);
      }

      // é¡µé¢å¸è½½/åˆ‡èµ°æ—¶ä¿å­˜å½“å‰ taskIdï¼ˆbeforeunload æ¯” pagehide æ›´æ—©æ›´å¯é ï¼‰
      function saveTask() {
        if (_activeTaskId) {
          try {
            localStorage.setItem(TASK_KEY, JSON.stringify({
              taskId: _activeTaskId,
              enableBroadcast: _activeEnableBroadcast,
              hexIds: _activeHexIds,
              ts: Date.now()
            }));
          } catch(e) {}
        }
      }
      window.addEventListener('beforeunload', saveTask);
      window.addEventListener('pagehide', saveTask);
    })();
    document.querySelectorAll('input[name="hexChatMode"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (radio.checked) {
          setHexChatMode(radio.value);
          updateHexChatRoundsUI();
          updateHexChatState();
          if (hexChatMessages) { hexChatMessages.innerHTML = ''; loadHexChatHistory(); }
        }
      });
    });
    (function() {
      var overlay = document.getElementById('modalClearConfirm');
      var msgEl = document.getElementById('modalClearMessage');
      var chk = document.getElementById('modalClearMemory');
      var btnOk = document.getElementById('modalClearOk');
      var btnCancel = document.getElementById('modalClearCancel');
      function showClearConfirmModal(message) {
        msgEl.textContent = message;
        chk.checked = false;
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
        return new Promise(function(resolve) {
          function done(confirmed, clearMemory) {
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden', 'true');
            resolve({ confirmed: !!confirmed, clearMemory: !!clearMemory });
          }
          function onOk() {
            btnOk.removeEventListener('click', onOk);
            btnCancel.removeEventListener('click', onCancel);
            overlay.removeEventListener('click', onOverlay);
            done(true, chk.checked);
          }
          function onCancel() {
            btnOk.removeEventListener('click', onOk);
            btnCancel.removeEventListener('click', onCancel);
            overlay.removeEventListener('click', onOverlay);
            done(false, false);
          }
          function onOverlay(e) {
            if (e.target === overlay) onCancel();
          }
          btnOk.addEventListener('click', onOk);
          btnCancel.addEventListener('click', onCancel);
          overlay.addEventListener('click', onOverlay);
        });
      }
      var btnSingle = document.getElementById('hexChatClearSingle');
      var btnDiscuss = document.getElementById('hexChatClearDiscuss');
      var btnAll = document.getElementById('hexChatClearAll');
      if (btnSingle) btnSingle.addEventListener('click', function() {
        showClearConfirmModal('ç¡®å®šæ¸…ç©ºå•èŠä¸å¦å¯¹è¯è®°å½•ï¼Ÿ').then(function(r) {
          if (!r.confirmed) return;
          clearHexChatHistoryByMode('single');
          if (r.clearMemory && projectId) fetch('/api/project-memory/' + encodeURIComponent(projectId), { method: 'DELETE' }).catch(function() {});
          show('å·²æ¸…ç©ºå•èŠè®°å½•' + (r.clearMemory ? 'åŠæœ¬é¡¹ç›®è®°å¿†' : ''));
        });
      });
      if (btnDiscuss) btnDiscuss.addEventListener('click', function() {
        showClearConfirmModal('ç¡®å®šæ¸…ç©ºç¾¤èŠä¸å¦å¯¹è¯è®°å½•ï¼Ÿ').then(function(r) {
          if (!r.confirmed) return;
          clearHexChatHistoryByMode('discuss');
          if (r.clearMemory && projectId) fetch('/api/project-memory/' + encodeURIComponent(projectId), { method: 'DELETE' }).catch(function() {});
          show('å·²æ¸…ç©ºç¾¤èŠè®°å½•' + (r.clearMemory ? 'åŠæœ¬é¡¹ç›®è®°å¿†' : ''));
        });
      });
      if (btnAll) btnAll.addEventListener('click', function() {
        showClearConfirmModal('ç¡®å®šæ¸…ç©ºå…¨éƒ¨ä¸å¦å¯¹è¯è®°å½•ï¼Ÿ').then(function(r) {
          if (!r.confirmed) return;
          clearHexChatHistoryByMode('all');
          if (r.clearMemory && projectId) fetch('/api/project-memory/' + encodeURIComponent(projectId), { method: 'DELETE' }).catch(function() {});
          show('å·²æ¸…ç©ºå…¨éƒ¨è®°å½•' + (r.clearMemory ? 'åŠæœ¬é¡¹ç›®è®°å¿†' : ''));
        });
      });
      window.showClearConfirmModal = showClearConfirmModal;
    })();
    if (hexChatMessages) {
      hexChatMessages.addEventListener('click', function(e) {
        if (e.target && e.target.classList && e.target.classList.contains('hex-chat-share')) {
          var msg = e.target.closest('.hex-chat-msg');
          if (msg) {
            var name = msg.getAttribute('data-name') || 'ä½ ';
            var message = msg.getAttribute('data-message') || '';
            shareToDiscuss(name, message);
          }
        }
      });
    }
    if (hexChatRoundsBtn && hexChatRoundsPopover) {
      hexChatRoundsBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (hexChatRoundsBtn.classList.contains('disabled')) return;
        hexChatRoundsPopover.classList.toggle('show');
      });
      hexChatRoundsPopover.addEventListener('click', function(e) { e.stopPropagation(); });
      hexChatRoundsPopover.querySelectorAll('.hex-chat-rounds-opt').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var n = parseInt(btn.getAttribute('data-rounds'), 10);
          setHexChatMaxRounds(n);
          updateHexChatRoundsUI();
          updateHexChatState();
          hexChatRoundsPopover.classList.remove('show');
        });
      });
      document.addEventListener('click', function() { hexChatRoundsPopover.classList.remove('show'); });
    }

    // ä¸é˜´å¯¹è¯åŠŸèƒ½
    var YIN_CHAT_STORAGE_KEY_PREFIX = 'yin_chat_history_project_';
    var _yinChatCache = null; // é˜´çš„å†å²å†…å­˜ç¼“å­˜

    function getYinChatStorageKey() {
      return projectId ? YIN_CHAT_STORAGE_KEY_PREFIX + projectId : null;
    }

    function getYinChatHistoryForAPI() {
      // è¿”å›ç»™åç«¯çš„å†å²æ ¼å¼ï¼ˆæœ€è¿‘15æ¡ï¼‰
      return (_yinChatCache || []).slice(-15);
    }

    function saveYinChatHistory() {
      if (!projectId || !yinChatMessages) return;
      var messages = [];
      yinChatMessages.querySelectorAll('.yin-chat-msg').forEach(function(msg) {
        var role = msg.classList.contains('user') ? 'user' : 'yin';
        var text = msg.textContent.replace(/^(æˆ‘|é˜´)\s*/, '');
        messages.push({ role: role, text: text });
      });
      _yinChatCache = messages;
      // å¼‚æ­¥ä¿å­˜åˆ°æœåŠ¡å™¨
      fetch('/api/chat-history/' + encodeURIComponent(projectId) + '/yin', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: messages })
      }).catch(function(e) { console.warn('ä¿å­˜é˜´å¯¹è¯å†å²åˆ°æœåŠ¡å™¨å¤±è´¥:', e); });
      // åŒæ—¶ä¿ç•™ localStorage å¤‡ä»½
      try { localStorage.setItem(getYinChatStorageKey(), JSON.stringify(messages)); } catch (e) {}
    }

    function loadYinChatHistory() {
      if (!projectId || !yinChatMessages) return;
      fetch('/api/chat-history/' + encodeURIComponent(projectId) + '/yin')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var messages = data.messages || [];
          // æœåŠ¡å™¨æ— è®°å½•æ—¶ä» localStorage è¿ç§»
          if (messages.length === 0) {
            try {
              var local = localStorage.getItem(getYinChatStorageKey());
              if (local) {
                messages = JSON.parse(local);
                if (messages.length > 0) {
                  fetch('/api/chat-history/' + encodeURIComponent(projectId) + '/yin', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messages })
                  }).catch(function() {});
                }
              }
            } catch (e) {}
          }
          _yinChatCache = messages;
          messages.forEach(function(msg) { appendYinChatMsg(msg.role, msg.text, false); });
          if (messages.length === 0) appendYinChatEmptyHint();
        })
        .catch(function(e) {
          console.warn('ä»æœåŠ¡å™¨åŠ è½½é˜´å¯¹è¯å†å²å¤±è´¥ï¼Œé™çº§åˆ° localStorage:', e);
          try {
            var local = localStorage.getItem(getYinChatStorageKey());
            if (local) {
              var msgs = JSON.parse(local);
              _yinChatCache = msgs;
              msgs.forEach(function(msg) { appendYinChatMsg(msg.role, msg.text, false); });
            }
            if (yinChatMessages && !yinChatMessages.querySelectorAll('.yin-chat-msg').length) appendYinChatEmptyHint();
          } catch (e2) {
            if (yinChatMessages && !yinChatMessages.querySelectorAll('.yin-chat-msg').length) appendYinChatEmptyHint();
          }
        });
    }

    function appendYinChatEmptyHint() {
      if (!yinChatMessages) return;
      var el = document.createElement('div');
      el.className = 'yin-chat-empty-hint';
      el.style.cssText = 'color:var(--text-dim);font-size:0.85rem;padding:12px 0;';
      el.textContent = 'é˜´å·²å°±ç»ªï¼Œå¯ä¸é˜´å¯¹è¯è¯´æ˜éœ€æ±‚ã€‚';
      yinChatMessages.appendChild(el);
      yinChatMessages.scrollTop = yinChatMessages.scrollHeight;
    }

    function appendYinChatMsg(role, text, save) {
      if (save === undefined) save = true;
      if (!yinChatMessages) return;
      var hint = yinChatMessages.querySelector('.yin-chat-empty-hint');
      if (hint) hint.remove();
      var div = document.createElement('div');
      div.className = 'yin-chat-msg ' + role;
      var who = role === 'user' ? 'æˆ‘' : 'é˜´';
      var textHtml = role === 'user' ? escapeHtml(text) : ('<span class="yin-chat-md">' + (typeof marked !== 'undefined' ? marked.parse(String(text || ''), { breaks: true, gfm: true }) : escapeHtml(text)) + '</span>');
      div.innerHTML = '<span class="who">' + escapeHtml(who) + '</span>' + textHtml;
      yinChatMessages.appendChild(div);
      yinChatMessages.scrollTop = yinChatMessages.scrollHeight;
      if (save) {
        saveYinChatHistory();
      }
    }

    if (yinChatSend) {
      var YIN_TASK_KEY = 'yinChatTask_' + (projectId || '');
      var _yinPollTimer = null;
      function pollYinTask(taskId) {
        fetch('/api/yin/task/' + encodeURIComponent(taskId))
          .then(function(r) { return r.json(); })
          .then(function(task) {
            if (task.status === 'done') {
              try { sessionStorage.removeItem(YIN_TASK_KEY); } catch (e) {}
              if (task.reply) appendYinChatMsg('yin', task.reply);
              yinChatSend.disabled = false;
              saveYinChatHistory();
              return;
            }
            if (task.status === 'error') {
              try { sessionStorage.removeItem(YIN_TASK_KEY); } catch (e) {}
              appendYinChatMsg('yin', 'ï¼ˆ' + (task.error || 'æš‚æ—¶æ— æ³•æ”¶åˆ°é˜´çš„å›å¤') + 'ï¼‰');
              yinChatSend.disabled = false;
              return;
            }
            _yinPollTimer = setTimeout(function() { pollYinTask(taskId); }, 1500);
          })
          .catch(function() {
            _yinPollTimer = setTimeout(function() { pollYinTask(taskId); }, 2000);
          });
      }
      yinChatSend.addEventListener('click', function() {
        var text = (yinChatInput && yinChatInput.value) ? yinChatInput.value.trim() : '';
        if (!text || !projectId) return;
        yinChatInput.value = '';
        appendYinChatMsg('user', text);
        yinChatSend.disabled = true;
        fetch('/api/yin/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, projectId: projectId, history: getYinChatHistoryForAPI() })
        })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var taskId = data && data.taskId;
            if (!taskId) {
              var err = (data && data.error) ? data.error : 'æœªè¿”å› taskId';
              appendYinChatMsg('yin', 'ï¼ˆæš‚æ—¶æ— æ³•æ”¶åˆ°é˜´çš„å›å¤ï¼š' + err + 'ï¼‰');
              yinChatSend.disabled = false;
              return;
            }
            try { sessionStorage.setItem(YIN_TASK_KEY, taskId); } catch (e) {}
            pollYinTask(taskId);
          })
          .catch(function(e) {
            appendYinChatMsg('yin', 'ï¼ˆè¯·æ±‚å¤±è´¥ï¼š' + (e.message || 'ç½‘ç»œé”™è¯¯') + 'ï¼‰');
            yinChatSend.disabled = false;
          });
      });
      window.addEventListener('beforeunload', function() {
        if (_yinPollTimer) clearTimeout(_yinPollTimer);
      });
      (function() {
        try {
          var savedTaskId = sessionStorage.getItem(YIN_TASK_KEY);
          if (!savedTaskId) return;
          yinChatSend.disabled = true;
          show('ç­‰å¾…é˜´å›å¤ä¸­â€¦ï¼ˆæ¢é¡µä¸ä¸­æ–­ï¼‰');
          pollYinTask(savedTaskId);
        } catch (e) {}
      })();
    }
    if (yinChatInput) yinChatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') yinChatSend.click();
    });

    var yinChatClearBtn = document.getElementById('yinChatClearBtn');
    if (yinChatClearBtn) {
      yinChatClearBtn.addEventListener('click', function() {
        var fn = window.showClearConfirmModal;
        if (!fn) return;
        fn('ç¡®å®šæ¸…ç©ºä¸é˜´çš„å…¨éƒ¨èŠå¤©è®°å½•ï¼Ÿ').then(function(r) {
          if (!r.confirmed) return;
          _yinChatCache = [];
          if (yinChatMessages) { yinChatMessages.innerHTML = ''; appendYinChatEmptyHint(); }
          try { localStorage.removeItem(getYinChatStorageKey()); } catch (e) {}
          if (projectId) {
            fetch('/api/chat-history/' + encodeURIComponent(projectId) + '/yin', { method: 'DELETE' })
              .catch(function(e) { console.warn('æ¸…ç©ºé˜´å†å²å¤±è´¥:', e); });
            if (r.clearMemory) fetch('/api/project-memory/' + encodeURIComponent(projectId), { method: 'DELETE' }).catch(function() {});
          }
          show('å·²æ¸…ç©ºä¸é˜´çš„èŠå¤©è®°å½•' + (r.clearMemory ? 'åŠæœ¬é¡¹ç›®è®°å¿†' : ''));
        });
      });
    }

    function load() {
      if (!projectId) {
        nameEl.textContent = 'æœªæŒ‡å®šé¡¹ç›®';
        show('è¯·ä»é¡¹ç›®åˆ—è¡¨è¿›å…¥');
        return;
      }
      Promise.all([
        fetch('/api/projects/' + encodeURIComponent(projectId)).then(function(r) {
          if (!r.ok) throw new Error(r.status === 404 ? 'é¡¹ç›®ä¸å­˜åœ¨' : 'åŠ è½½å¤±è´¥');
          return r.json();
        }),
        fetch('/api/robots').then(function(r) { return r.json(); })
      ]).then(function(results) {
        project = results[0];
        robots = results[1] || [];
        hexList = robots.filter(function(r) { return r.id !== 'main' && r.id !== 'lan'; });
        document.title = project.name + ' Â· é¡¹ç›®';
        nameEl.textContent = project.name;
        breadcrumbSep.style.display = 'inline';
        breadcrumbProject.textContent = project.name;
        renderRing();
        renderHexSwitches();
        var hasHex = (project.hexIds && project.hexIds.length) > 0;
        if (hexChatEmpty) hexChatEmpty.style.display = hasHex ? 'none' : 'block';
        if (hexChatModeRow) hexChatModeRow.style.display = hasHex ? 'flex' : 'none';
        if (hexChatRow) hexChatRow.style.display = hasHex ? 'flex' : 'none';
        var toolbar = document.getElementById('hexChatToolbar');
        if (toolbar) toolbar.style.display = hasHex ? 'flex' : 'none';
        setHexChatFormEnabled(hasHex);
        updateHexChatModeUI();
        updateHexChatRoundsUI();
        updateHexChatState();
        // åŠ è½½å¯¹è¯å†å²è®°å½•
        loadHexChatHistory();
        loadYinChatHistory();
        // å¦‚æœURLä¸­æœ‰openSelectå‚æ•°ï¼Œæ‰“å¼€é€‰å¦å¼¹çª—
        if (/[?&]openSelect=1/.test(window.location.search)) {
          openSelectHexModal();
          history.replaceState(null, '', window.location.pathname + '?id=' + encodeURIComponent(projectId));
        }
        // å®šæ—¶åŒæ­¥å¦è¿è¡ŒçŠ¶æ€ï¼šæœ‰å¦å¤„äºè¿‡æ¸¡çŠ¶æ€æ—¶ 1sï¼Œç¨³å®šåé™åˆ° 5s
        if (!window._projectRobotRefresh) {
          var _prevRunningState = {};
          var _projectPollTimer = null;
          function scheduleProjectPoll() {
            var hasStarting = !!document.querySelector('.btn-hex-action[disabled]');
            var interval = hasStarting ? 1000 : 5000;
            _projectPollTimer = setTimeout(function() {
              if (!projectId || !project) { scheduleProjectPoll(); return; }
              fetch('/api/robots').then(function(r) { return r.json(); }).then(function(list) {
                var changed = false;
                (list || []).forEach(function(r) {
                  if (_prevRunningState[r.id] !== undefined && _prevRunningState[r.id] !== r.running) changed = true;
                  _prevRunningState[r.id] = r.running;
                });
                var updateFn = function(src) {
                  robots = src || [];
                  hexList = robots.filter(function(r) { return r.id !== 'main' && r.id !== 'lan'; });
                  renderRing();
                  renderHexSwitches();
                  updateYinyangState(robots);
                  scheduleProjectPoll();
                };
                if (changed) {
                  fetch('/api/robots?nocache=1').then(function(r2) { return r2.json(); }).then(updateFn).catch(function() { scheduleProjectPoll(); });
                } else {
                  updateFn(list);
                }
              }).catch(function() { scheduleProjectPoll(); });
            }, interval);
          }
          window._projectRobotRefresh = true;
          scheduleProjectPoll();
        }
        // ç»‘å®šé˜´é˜³æŒ‰é’®ï¼šç‚¹å‡»åˆ‡æ¢å¯åŠ¨/åœæ­¢
        bindYinyangButtons();
      }).catch(function(e) {
        nameEl.textContent = 'åŠ è½½å¤±è´¥';
        show(e.message || 'è¯·æ±‚å¤±è´¥');
      });
    }

    // æ›´æ–°é˜´é˜³æŒ‰é’®çŠ¶æ€
    function updateYinyangState(robots) {
      const byId = {};
      (robots || []).forEach(function(r) { byId[r.id] = r; });
      document.querySelectorAll('.taiji-dot').forEach(function(btn) {
        const r = byId[btn.dataset.robot];
        const isRunning = !!r && !!r.running;
        btn.classList.toggle('running', isRunning);
        if (isRunning) {
          btn.classList.remove('starting');
          btn.title = (btn.dataset.robot === 'main' ? 'é˜´ Â· å¹³å°æ€»æ§' : 'é˜³') + ' Â· ç‚¹å‡»åœæ­¢';
        } else {
          btn.title = (btn.dataset.robot === 'main' ? 'é˜´ Â· å¹³å°æ€»æ§' : 'é˜³') + ' Â· ç‚¹å‡»å¯åŠ¨';
        }
      });
    }

    // ç»‘å®šé˜´é˜³æŒ‰é’®ï¼šç‚¹å‡»åˆ‡æ¢å¯åŠ¨/åœæ­¢
    function bindYinyangButtons() {
      document.querySelectorAll('.taiji-dot').forEach(function(btn) {
        const robotId = btn.dataset.robot;
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener('click', async function() {
          const robots = await fetch('/api/robots').then(function(r) { return r.json(); }).catch(function() { return []; });
          const robot = robots.find(function(r) { return r.id === robotId; });
          const isRunning = !!(robot && robot.running);
          if (isRunning) {
            // è¿è¡Œä¸­ï¼šç‚¹å‡»åœæ­¢
            newBtn.disabled = true;
            try {
              const r = await fetch('/api/stop/' + robotId, { method: 'POST' });
              const data = await r.json().catch(function() { return {}; });
              if (r.ok && !data.error) {
                show('å·²åœæ­¢');
                const next = await fetch('/api/robots').then(function(r) { return r.json(); }).catch(function() { return []; });
                updateYinyangState(next);
              } else {
                show(data.error || 'åœæ­¢å¤±è´¥');
              }
            } catch (e) {
              show('è¯·æ±‚å¤±è´¥: ' + (e.message || ''));
            }
            newBtn.disabled = false;
          } else {
            // æœªè¿è¡Œï¼šç‚¹å‡»å¯åŠ¨
            newBtn.classList.add('starting');
            try {
              const r = await fetch('/api/open-tui/' + robotId, { method: 'POST' });
              const data = await r.json().catch(function() { return {}; });
              if (r.ok && !data.error) {
                show('å·²å¼¹å‡ºç»ˆç«¯');
              } else {
                show(data.error || 'å¯åŠ¨å¤±è´¥ (HTTP ' + r.status + ')');
                newBtn.classList.remove('starting');
              }
            } catch (e) {
              show('è¯·æ±‚å¤±è´¥: ' + (e.message || ''));
              newBtn.classList.remove('starting');
            }
          }
        });
      });
    }

    // åˆå§‹åŒ–æ—¶æ›´æ–°é˜´é˜³çŠ¶æ€
    fetch('/api/robots').then(function(r) { return r.json(); }).then(updateYinyangState).catch(function() {});

    load();
  </script>
</body>
</html>
